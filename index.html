<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تسجيل وتقييم الطلاب</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');
        
        * {
            font-family: 'Tajawal', sans-serif;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .score-btn {
            transition: all 0.2s ease;
        }
        
        .score-btn.selected {
            transform: scale(1.05);
        }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
        
        .modal-content {
            z-index: 50;
        }
        
        /* تخصيص شريط التمرير */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- شاشة التحميل -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-gray-700 text-lg">جاري تحميل التطبيق...</p>
    </div>

    <!-- التطبيق الرئيسي -->
    <div id="app" class="hidden">
        <!-- الهيدر -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold">نظام تقييم الطلاب</h1>
                <div class="flex space-x-2 space-x-reverse">
                    <button id="settingsBtn" class="bg-white text-purple-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-100 transition">
                        <i class="fas fa-cog mr-2"></i>الإعدادات
                    </button>
                    <button id="exportAppBtn" class="bg-white text-purple-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-100 transition">
                        <i class="fas fa-download mr-2"></i>تصدير التطبيق
                    </button>
                </div>
            </div>
        </header>

        <!-- القائمة الرئيسية -->
        <main id="mainMenu" class="container mx-auto px-4 py-8 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover flex flex-col items-center text-center">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-user-plus text-green-600 text-3xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">تسجيل طالب جديد</h2>
                    <p class="text-gray-600 mb-6">إضافة طالب جديد إلى قاعدة البيانات</p>
                    <button id="registerBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium w-full transition">
                        ابدأ التسجيل
                    </button>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover flex flex-col items-center text-center">
                    <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-clipboard-check text-blue-600 text-3xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">تقييم الطلاب</h2>
                    <p class="text-gray-600 mb-6">تقييم الطلاب المسجلين في النظام</p>
                    <button id="evaluateBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium w-full transition">
                        ابدأ التقييم
                    </button>
                </div>
            </div>
            
            <!-- قسم تصدير النتائج -->
            <div class="mt-12 bg-white rounded-xl shadow-lg p-6 max-w-4xl mx-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">تصدير النتائج</h2>
                <div class="flex flex-col md:flex-row justify-center gap-4">
                    <button id="exportAllResultsBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-medium transition">
                        <i class="fas fa-file-export mr-2"></i>تصدير نتائج كل الطلاب
                    </button>
                </div>
            </div>
        </main>

        <!-- شاشة تسجيل الطالب -->
        <section id="registrationScreen" class="container mx-auto px-4 py-8 hidden fade-in">
            <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-6">
                    <button id="backFromRegistration" class="text-gray-600 hover:text-gray-800 mr-4">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <h2 class="text-2xl font-bold text-gray-800">تسجيل طالب جديد</h2>
                </div>
                
                <form id="studentForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="studentName" class="block text-gray-700 mb-2">اسم الطالب كاملاً</label>
                            <input type="text" id="studentName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                        </div>
                        
                        <div>
                            <label for="studentGrade" class="block text-gray-700 mb-2">الصف الدراسي</label>
                            <select id="studentGrade" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                                <option value="">اختر الصف</option>
                                <option value="1">الصف الأول</option>
                                <option value="2">الصف الثاني</option>
                                <option value="3">الصف الثالث</option>
                                <option value="4">الصف الرابع</option>
                                <option value="5">الصف الخامس</option>
                                <option value="6">الصف السادس</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="studentClass" class="block text-gray-700 mb-2">رقم الشعبة/الفصل</label>
                            <select id="studentClass" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                                <option value="">اختر الشعبة</option>
                                <option value="1">شعبة 1</option>
                                <option value="2">شعبة 2</option>
                                <option value="3">شعبة 3</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="studentSection" class="block text-gray-700 mb-2">القسم</label>
                            <select id="studentSection" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                                <option value="">اختر القسم</option>
                                <option value="عام">عام</option>
                                <option value="تحفيظ">تحفيظ</option>
                                <option value="دبلومة">دبلومة</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="studentGroup" class="block text-gray-700 mb-2">مجموعة المربي المخلص</label>
                            <input type="text" id="studentGroup" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                        </div>
                        
                        <div>
                            <label for="broadcastDate" class="block text-gray-700 mb-2">تاريخ الإذاعة</label>
                            <input type="date" id="broadcastDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-8">
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium transition">
                            <i class="fas fa-save mr-2"></i>سجل الطالب الآن
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- شاشة التحقق من كلمة المرور -->
        <section id="passwordScreen" class="container mx-auto px-4 py-8 hidden fade-in">
            <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">التحقق من كلمة المرور</h2>
                
                <div class="mb-6">
                    <label for="passwordInput" class="block text-gray-700 mb-2">كلمة المرور</label>
                    <input type="password" id="passwordInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="أدخل كلمة المرور">
                </div>
                
                <div class="flex justify-between">
                    <button id="backFromPassword" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition">
                        رجوع
                    </button>
                    <button id="verifyPassword" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition">
                        تحقق
                    </button>
                </div>
            </div>
        </section>

        <!-- شاشة قائمة الطلاب -->
        <section id="studentsListScreen" class="container mx-auto px-4 py-8 hidden fade-in">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center">
                        <button id="backFromStudentsList" class="text-gray-600 hover:text-gray-800 mr-4">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <h2 class="text-2xl font-bold text-gray-800">قائمة الطلاب</h2>
                    </div>
                    <button id="exportAllBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium transition hidden">
                        <i class="fas fa-file-export mr-2"></i>تصدير الكل
                    </button>
                </div>
                
                <div id="studentsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- سيتم ملء هذه القائمة بالطلاب من localStorage -->
                </div>
            </div>
        </section>

        <!-- شاشة تقييم الطالب -->
        <section id="evaluationScreen" class="container mx-auto px-4 py-8 hidden fade-in">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center">
                        <button id="backFromEvaluation" class="text-gray-600 hover:text-gray-800 mr-4">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <h2 class="text-2xl font-bold text-gray-800">تقييم الطالب</h2>
                    </div>
                    <button id="exportStudentPdf" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition">
                        <i class="fas fa-file-pdf mr-2"></i>تصدير إلى PDF
                    </button>
                </div>
                
                <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                    <h3 id="studentInfo" class="text-lg font-semibold text-blue-800"></h3>
                </div>
                
                <form id="evaluationForm" class="space-y-6">
                    <div>
                        <label for="evaluatorName" class="block text-gray-700 mb-2">اسم المقيّم</label>
                        <select id="evaluatorName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                            <option value="">اختر المقيّم</option>
                            <option value="محمد مفرح العتيبي">محمد مفرح العتيبي</option>
                            <option value="فهد الطوياوي">فهد الطوياوي</option>
                            <option value="منتصر محمد">منتصر محمد</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- معايير التقييم -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">معايير التقييم</h3>
                            
                            <div class="evaluation-criterion">
                                <h4 class="font-medium text-gray-700 mb-2">الإعداد الجيد</h4>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" data-criterion="preparation" data-score="5" class="score-btn bg-gray-200 hover:bg-green-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">ممتاز</button>
                                    <button type="button" data-criterion="preparation" data-score="4" class="score-btn bg-gray-200 hover:bg-blue-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">جيد جداً</button>
                                    <button type="button" data-criterion="preparation" data-score="3" class="score-btn bg-gray-200 hover:bg-yellow-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">جيد</button>
                                    <button type="button" data-criterion="preparation" data-score="2" class="score-btn bg-gray-200 hover:bg-orange-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">مقبول</button>
                                    <button type="button" data-criterion="preparation" data-score="1" class="score-btn bg-gray-200 hover:bg-red-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">ضعيف</button>
                                </div>
                                <input type="hidden" id="preparationScore" name="preparationScore">
                            </div>
                            
                            <div class="evaluation-criterion">
                                <h4 class="font-medium text-gray-700 mb-2">التنوع</h4>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" data-criterion="diversity" data-score="5" class="score-btn bg-gray-200 hover:bg-green-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">ممتاز</button>
                                    <button type="button" data-criterion="diversity" data-score="4" class="score-btn bg-gray-200 hover:bg-blue-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">جيد جداً</button>
                                    <button type="button" data-criterion="diversity" data-score="3" class="score-btn bg-gray-200 hover:bg-yellow-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">جيد</button>
                                    <button type="button" data-criterion="diversity" data-score="2" class="score-btn bg-gray-200 hover:bg-orange-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">مقبول</button>
                                    <button type="button" data-criterion="diversity" data-score="1" class="score-btn bg-gray-200 hover:bg-red-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">ضعيف</button>
                                </div>
                                <input type="hidden" id="diversityScore" name="diversityScore">
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">&nbsp;</h3>
                            
                            <div class="evaluation-criterion">
                                <h4 class="font-medium text-gray-700 mb-2">وضوح الرسالة الموجهة</h4>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" data-criterion="clarity" data-score="5" class="score-btn bg-gray-200 hover:bg-green-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">ممتاز</button>
                                    <button type="button" data-criterion="clarity" data-score="4" class="score-btn bg-gray-200 hover:bg-blue-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">جيد جداً</button>
                                    <button type="button" data-criterion="clarity" data-score="3" class="score-btn bg-gray-200 hover:bg-yellow-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">جيد</button>
                                    <button type="button" data-criterion="clarity" data-score="2" class="score-btn bg-gray-200 hover:bg-orange-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">مقبول</button>
                                    <button type="button" data-criterion="clarity" data-score="1" class="score-btn bg-gray-200 hover:bg-red-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">ضعيف</button>
                                </div>
                                <input type="hidden" id="clarityScore" name="clarityScore">
                            </div>
                            
                            <div class="evaluation-criterion">
                                <h4 class="font-medium text-gray-700 mb-2">جودة الإلقاء</h4>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" data-criterion="delivery" data-score="5" class="score-btn bg-gray-200 hover:bg-green-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">ممتاز</button>
                                    <button type="button" data-criterion="delivery" data-score="4" class="score-btn bg-gray-200 hover:bg-blue-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">جيد جداً</button>
                                    <button type="button" data-criterion="delivery" data-score="3" class="score-btn bg-gray-200 hover:bg-yellow-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">جيد</button>
                                    <button type="button" data-criterion="delivery" data-score="2" class="score-btn bg-gray-200 hover:bg-orange-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">مقبول</button>
                                    <button type="button" data-criterion="delivery" data-score="1" class="score-btn bg-gray-200 hover:bg-red-500 hover:text-white text-gray-800 px-3 py-2 rounded-lg transition">ضعيف</button>
                                </div>
                                <input type="hidden" id="deliveryScore" name="deliveryScore">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-8">
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium transition">
                            <i class="fas fa-save mr-2"></i>حفظ التقييم
                        </button>
                    </div>
                </form>
                
                <!-- سجل التقييمات السابقة -->
                <div id="evaluationHistory" class="mt-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">سجل التقييمات السابقة</h3>
                    <div id="historyList" class="space-y-4">
                        <!-- سيتم ملء هذا القسم بالتقييمات السابقة -->
                    </div>
                </div>
            </div>
        </section>

        <!-- نموذج الإعدادات -->
        <div id="settingsModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
            <div class="modal-overlay absolute inset-0" id="settingsOverlay"></div>
            <div class="modal-content bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-screen overflow-y-auto relative">
                <div class="p-6 border-b">
                    <h2 class="text-2xl font-bold text-gray-800">الإعدادات</h2>
                </div>
                
                <div class="p-6 space-y-6">
                    <!-- إعدادات PDF -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">تخصيص نموذج PDF</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2">رفع صورة الخلفية</label>
                                <input type="file" id="backgroundImage" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">نص العنوان</label>
                                <input type="text" id="pdfTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="تقرير تقييم الطالب">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">نص التذييل</label>
                                <textarea id="pdfFooter" class="w-full px-4 py-2 border border-gray-300 rounded-lg" rows="3">شكراً لجهودكم المتميزة</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- إعدادات التطبيق -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">إعدادات التطبيق</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2">كلمة المرور للتقييم</label>
                                <input type="password" id="appPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="123">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">أسماء المقيّمين</label>
                                <textarea id="evaluatorNames" class="w-full px-4 py-2 border border-gray-300 rounded-lg" rows="3">محمد مفرح العتيبي, فهد الطوياوي, منتصر محمد</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 border-t flex justify-end space-x-3 space-x-reverse">
                    <button id="closeSettings" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition">
                        إغلاق
                    </button>
                    <button id="saveSettings" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition">
                        حفظ الإعدادات
                    </button>
                </div>
            </div>
        </div>

        <!-- نموذج تصدير التطبيق -->
        <div id="exportAppModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
            <div class="modal-overlay absolute inset-0" id="exportAppOverlay"></div>
            <div class="modal-content bg-white rounded-xl shadow-2xl max-w-md w-full relative">
                <div class="p-6 border-b">
                    <h2 class="text-2xl font-bold text-gray-800">تصدير التطبيق</h2>
                </div>
                
                <div class="p-6">
                    <p class="text-gray-700 mb-6">سيتم تصدير التطبيق كاملاً إلى ملف HTML يمكن تشغيله محلياً على أي جهاز.</p>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 mb-2">اسم الملف</label>
                        <input type="text" id="exportFileName" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="تطبيق_تقييم_الطلاب">
                    </div>
                </div>
                
                <div class="p-6 border-t flex justify-end space-x-3 space-x-reverse">
                    <button id="closeExportApp" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition">
                        إلغاء
                    </button>
                    <button id="confirmExportApp" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium transition">
                        <i class="fas fa-download mr-2"></i>تصدير التطبيق
                    </button>
                </div>
            </div>
        </div>

        <!-- نموذج تأكيد PDF -->
        <div id="pdfConfirmModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
            <div class="modal-overlay absolute inset-0" id="pdfConfirmOverlay"></div>
            <div class="modal-content bg-white rounded-xl shadow-2xl max-w-md w-full relative">
                <div class="p-6 border-b">
                    <h2 class="text-2xl font-bold text-gray-800">تصدير إلى PDF</h2>
                </div>
                
                <div class="p-6">
                    <p class="text-gray-700 mb-6">هل أنت متأكد أنك تريد تصدير التقرير إلى ملف PDF؟</p>
                </div>
                
                <div class="p-6 border-t flex justify-end space-x-3 space-x-reverse">
                    <button id="cancelPdf" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition">
                        إلغاء
                    </button>
                    <button id="confirmPdf" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium transition">
                        <i class="fas fa-file-pdf mr-2"></i>تأكيد التصدير
                    </button>
                </div>
            </div>
        </div>

        <!-- نموذج الرسائل -->
        <div id="messageModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
            <div class="modal-overlay absolute inset-0" id="messageOverlay"></div>
            <div class="modal-content bg-white rounded-xl shadow-2xl max-w-md w-full relative">
                <div id="messageHeader" class="p-6 border-b">
                    <h2 id="messageTitle" class="text-2xl font-bold"></h2>
                </div>
                
                <div class="p-6">
                    <p id="messageText" class="text-gray-700"></p>
                </div>
                
                <div class="p-6 border-t flex justify-end">
                    <button id="closeMessage" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition">
                        موافق
                    </button>
                </div>
            </div>
        </div>

        <!-- نموذج معاينة PDF للطالب -->
        <div id="studentPdfPreview" class="fixed inset-0 z-50 hidden overflow-auto p-4">
            <div class="modal-overlay absolute inset-0" id="studentPdfOverlay"></div>
            <div class="modal-content bg-white rounded-xl shadow-2xl max-w-4xl w-full relative my-8">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">معاينة تقرير الطالب</h2>
                    <button id="closeStudentPdfPreview" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-6">
                    <div id="studentReport" class="bg-white p-8 border border-gray-300">
                        <div class="text-center mb-8">
                            <h1 id="reportTitle" class="text-2xl font-bold mb-2">تقرير تقييم الطالب</h1>
                            <p id="reportDate" class="text-gray-600"></p>
                        </div>
                        
                        <div class="mb-6">
                            <h2 class="text-xl font-semibold mb-4">معلومات الطالب</h2>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div><strong>اسم الطالب:</strong> <span id="reportStudentName"></span></div>
                                <div><strong>الصف الدراسي:</strong> <span id="reportStudentGrade"></span></div>
                                <div><strong>الشعبة:</strong> <span id="reportStudentClass"></span></div>
                                <div><strong>القسم:</strong> <span id="reportStudentSection"></span></div>
                                <div><strong>المجموعة:</strong> <span id="reportStudentGroup"></span></div>
                                <div><strong>تاريخ الإذاعة:</strong> <span id="reportBroadcastDate"></span></div>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h2 class="text-xl font-semibold mb-4">نتيجة التقييم</h2>
                            <table class="w-full border-collapse border border-gray-400">
                                <thead>
                                    <tr class="bg-gray-200">
                                        <th class="border border-gray-400 p-2">عناصر التقييم</th>
                                        <th class="border border-gray-400 p-2">ممتاز</th>
                                        <th class="border border-gray-400 p-2">جيد جداً</th>
                                        <th class="border border-gray-400 p-2">جيد</th>
                                        <th class="border border-gray-400 p-2">مقبول</th>
                                        <th class="border border-gray-400 p-2">ضعيف</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="border border-gray-400 p-2">الإعداد الجيد</td>
                                        <td class="border border-gray-400 p-2 text-center" id="preparationExcellent"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="preparationVeryGood"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="preparationGood"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="preparationAcceptable"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="preparationWeak"></td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-400 p-2">التنوع</td>
                                        <td class="border border-gray-400 p-2 text-center" id="diversityExcellent"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="diversityVeryGood"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="diversityGood"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="diversityAcceptable"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="diversityWeak"></td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-400 p-2">وضوح الرسالة الموجهة</td>
                                        <td class="border border-gray-400 p-2 text-center" id="clarityExcellent"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="clarityVeryGood"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="clarityGood"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="clarityAcceptable"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="clarityWeak"></td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-400 p-2">جودة الإلقاء</td>
                                        <td class="border border-gray-400 p-2 text-center" id="deliveryExcellent"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="deliveryVeryGood"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="deliveryGood"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="deliveryAcceptable"></td>
                                        <td class="border border-gray-400 p-2 text-center" id="deliveryWeak"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-8">
                            <h2 class="text-xl font-semibold mb-2">لجنة التقييم</h2>
                            <p id="reportEvaluators" class="text-gray-700"></p>
                        </div>
                        
                        <div class="mt-8 text-center">
                            <p id="reportFooter" class="text-gray-600">شكراً لجهودكم المتميزة</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 border-t flex justify-end">
                    <button id="confirmStudentPdf" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium transition">
                        <i class="fas fa-file-pdf mr-2"></i>تصدير إلى PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- نموذج معاينة PDF لجميع الطلاب -->
        <div id="allStudentsPdfPreview" class="fixed inset-0 z-50 hidden overflow-auto p-4">
            <div class="modal-overlay absolute inset-0" id="allStudentsPdfOverlay"></div>
            <div class="modal-content bg-white rounded-xl shadow-2xl max-w-6xl w-full relative my-8">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">معاينة تقرير جميع الطلاب</h2>
                    <button id="closeAllStudentsPdfPreview" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-6">
                    <div id="allStudentsReport" class="bg-white p-8 border border-gray-300">
                        <div class="text-center mb-8">
                            <h1 class="text-2xl font-bold mb-2">تقرير تقييم جميع الطلاب</h1>
                            <p id="allReportDate" class="text-gray-600"></p>
                        </div>
                        
                        <div id="studentsReportsList" class="space-y-8">
                            <!-- سيتم ملء هذا القسم بتقارير جميع الطلاب -->
                        </div>
                        
                        <div class="mt-8">
                            <h2 class="text-xl font-semibold mb-2">لجنة التقييم</h2>
                            <p id="allReportEvaluators" class="text-gray-700"></p>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 border-t flex justify-end">
                    <button id="confirmAllStudentsPdf" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium transition">
                        <i class="fas fa-file-pdf mr-2"></i>تصدير إلى PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // بيانات التطبيق
        let appData = {
            students: [],
            evaluations: [],
            settings: {
                password: '123',
                evaluators: ['محمد مفرح العتيبي', 'فهد الطوياوي', 'منتصر محمد'],
                pdfTitle: 'تقرير تقييم الطالب',
                pdfFooter: 'شكراً لجهودكم المتميزة'
            },
            currentStudent: null,
            currentEvaluation: null
        };
        
        // تهيئة التطبيق بعد تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // إخفاء شاشة التحميل بعد ثانيتين
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                showScreen('mainMenu');
                loadAppData();
            }, 1000);
            
            // تهيئة عناصر الواجهة
            initializeApp();
        });
        
        // تهيئة التطبيق
        function initializeApp() {
            // إعداد المستمعين للأحداث
            setupEventListeners();
            
            // تحميل البيانات من localStorage
            loadAppData();
        }
        
        // إعداد المستمعين للأحداث
        function setupEventListeners() {
            // أزرار القائمة الرئيسية
            document.getElementById('registerBtn').addEventListener('click', () => showScreen('registrationScreen'));
            document.getElementById('evaluateBtn').addEventListener('click', () => showScreen('passwordScreen'));
            document.getElementById('exportAllResultsBtn').addEventListener('click', showAllStudentsReport);
            
            // أزرار الرجوع
            document.getElementById('backFromRegistration').addEventListener('click', () => showScreen('mainMenu'));
            document.getElementById('backFromPassword').addEventListener('click', () => showScreen('mainMenu'));
            document.getElementById('backFromStudentsList').addEventListener('click', () => showScreen('mainMenu'));
            document.getElementById('backFromEvaluation').addEventListener('click', () => showScreen('studentsListScreen'));
            
            // نموذج تسجيل الطالب
            document.getElementById('studentForm').addEventListener('submit', handleStudentRegistration);
            
            // نموذج التحقق من كلمة المرور
            document.getElementById('verifyPassword').addEventListener('click', verifyPassword);
            
            // نموذج التقييم
            document.getElementById('evaluatorName').addEventListener('change', loadPreviousEvaluation);
            document.getElementById('evaluationForm').addEventListener('submit', handleEvaluationSubmit);
            
            // أزرار الإعدادات
            document.getElementById('settingsBtn').addEventListener('click', showSettingsModal);
            document.getElementById('closeSettings').addEventListener('click', hideSettingsModal);
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            
            // أزرار تصدير التطبيق
            document.getElementById('exportAppBtn').addEventListener('click', showExportAppModal);
            document.getElementById('closeExportApp').addEventListener('click', hideExportAppModal);
            document.getElementById('confirmExportApp').addEventListener('click', exportApp);
            
            // أزرار PDF
            document.getElementById('exportStudentPdf').addEventListener('click', showStudentPdfPreview);
            document.getElementById('closeStudentPdfPreview').addEventListener('click', hideStudentPdfPreview);
            document.getElementById('confirmStudentPdf').addEventListener('click', generateStudentPdf);
            
            document.getElementById('closeAllStudentsPdfPreview').addEventListener('click', hideAllStudentsPdfPreview);
            document.getElementById('confirmAllStudentsPdf').addEventListener('click', generateAllStudentsPdf);
            
            // أزرار النماذج العامة
            document.getElementById('closeMessage').addEventListener('click', hideMessageModal);
            
            // أزرار اختيار الدرجات
            document.querySelectorAll('.score-btn').forEach(button => {
                button.addEventListener('click', handleScoreSelection);
            });
            
            // إغلاق النماذج بالنقر خارجها
            document.getElementById('settingsOverlay').addEventListener('click', hideSettingsModal);
            document.getElementById('exportAppOverlay').addEventListener('click', hideExportAppModal);
            document.getElementById('studentPdfOverlay').addEventListener('click', hideStudentPdfPreview);
            document.getElementById('allStudentsPdfOverlay').addEventListener('click', hideAllStudentsPdfPreview);
            document.getElementById('messageOverlay').addEventListener('click', hideMessageModal);
        }
        
        // تحميل بيانات التطبيق من localStorage
        function loadAppData() {
            const savedData = localStorage.getItem('studentEvaluationApp');
            if (savedData) {
                appData = JSON.parse(savedData);
            }
            
            // تحديث قائمة المقيّمين في الإعدادات
            updateEvaluatorsList();
        }
        
        // حفظ بيانات التطبيق في localStorage
        function saveAppData() {
            localStorage.setItem('studentEvaluationApp', JSON.stringify(appData));
        }
        
        // إظهار شاشة معينة
        function showScreen(screenId) {
            // إخفاء جميع الشاشات
            document.querySelectorAll('main, section').forEach(element => {
                element.classList.add('hidden');
            });
            
            // إظهار الشاشة المطلوبة
            document.getElementById(screenId).classList.remove('hidden');
            
            // إذا كانت شاشة قائمة الطلاب، قم بتحميل القائمة
            if (screenId === 'studentsListScreen') {
                loadStudentsList();
            }
        }
        
        // معالجة تسجيل الطالب
        function handleStudentRegistration(e) {
            e.preventDefault();
            
            const studentData = {
                id: Date.now().toString(),
                name: document.getElementById('studentName').value,
                grade: document.getElementById('studentGrade').value,
                class: document.getElementById('studentClass').value,
                section: document.getElementById('studentSection').value,
                group: document.getElementById('studentGroup').value,
                broadcastDate: document.getElementById('broadcastDate').value,
                registrationDate: new Date().toISOString()
            };
            
            // إضافة الطالب إلى القائمة
            appData.students.push(studentData);
            saveAppData();
            
            // إعادة تعيين النموذج
            document.getElementById('studentForm').reset();
            
            // إظهار رسالة النجاح
            showMessage('نجاح', 'تم تسجيل الطالب بنجاح!', 'success');
        }
        
        // التحقق من كلمة المرور
        function verifyPassword() {
            const passwordInput = document.getElementById('passwordInput').value;
            
            if (passwordInput === appData.settings.password) {
                showScreen('studentsListScreen');
            } else {
                showMessage('خطأ', 'كلمة المرور غير صحيحة!', 'error');
            }
        }
        
        // تحميل قائمة الطلاب
        function loadStudentsList() {
            const studentsList = document.getElementById('studentsList');
            studentsList.innerHTML = '';
            
            if (appData.students.length === 0) {
                studentsList.innerHTML = '<p class="text-center text-gray-500 col-span-3 py-8">لا توجد طلاب مسجلين بعد</p>';
                return;
            }
            
            appData.students.forEach(student => {
                const studentCard = document.createElement('div');
                studentCard.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition';
                
                // حساب متوسط التقييمات للطالب
                const studentEvaluations = appData.evaluations.filter(eval => eval.studentId === student.id);
                let averageScore = 0;
                
                if (studentEvaluations.length > 0) {
                    const totalScore = studentEvaluations.reduce((sum, eval) => {
                        return sum + (eval.preparationScore + eval.diversityScore + eval.clarityScore + eval.deliveryScore) / 4;
                    }, 0);
                    
                    averageScore = totalScore / studentEvaluations.length;
                }
                
                studentCard.innerHTML = `
                    <h3 class="font-bold text-lg text-gray-800">${student.name}</h3>
                    <p class="text-gray-600 text-sm mt-1">الصف: ${student.grade} - الشعبة: ${student.class}</p>
                    <p class="text-gray-600 text-sm">المجموعة: ${student.group}</p>
                    <div class="mt-3 flex justify-between items-center">
                        <span class="text-sm ${averageScore >= 4 ? 'text-green-600' : averageScore >= 3 ? 'text-yellow-600' : 'text-red-600'}">
                            متوسط التقييم: ${averageScore.toFixed(1)}/5
                        </span>
                        <div class="flex space-x-2 space-x-reverse">
                            <button class="export-pdf-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition" data-id="${student.id}">
                                PDF
                            </button>
                            <button class="evaluate-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition" data-id="${student.id}">
                                تقييم
                            </button>
                        </div>
                    </div>
                `;
                
                studentsList.appendChild(studentCard);
            });
            
            // إضافة مستمعي الأحداث للأزرار
            document.querySelectorAll('.evaluate-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    openEvaluationScreen(studentId);
                });
            });
            
            document.querySelectorAll('.export-pdf-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    openStudentPdfPreview(studentId);
                });
            });
        }
        
        // فتح شاشة التقييم للطالب
        function openEvaluationScreen(studentId) {
            const student = appData.students.find(s => s.id === studentId);
            if (!student) return;
            
            appData.currentStudent = student;
            document.getElementById('studentInfo').textContent = 
                `الطالب: ${student.name} - الصف: ${student.grade} - الشعبة: ${student.class} - القسم: ${student.section}`;
            
            // إعادة تعيين النموذج
            document.getElementById('evaluationForm').reset();
            document.querySelectorAll('.score-btn').forEach(btn => {
                btn.classList.remove('selected', 'bg-green-500', 'bg-blue-500', 'bg-yellow-500', 'bg-orange-500', 'bg-red-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800');
            });
            
            // تحميل سجل التقييمات
            loadEvaluationHistory(studentId);
            
            showScreen('evaluationScreen');
        }
        
        // معالجة اختيار الدرجة
        function handleScoreSelection(e) {
            const button = e.target;
            const criterion = button.getAttribute('data-criterion');
            const score = parseInt(button.getAttribute('data-score'));
            
            // إزالة التحديد من جميع أزرار المعيار نفسه
            document.querySelectorAll(`.score-btn[data-criterion="${criterion}"]`).forEach(btn => {
                btn.classList.remove('selected', 'bg-green-500', 'bg-blue-500', 'bg-yellow-500', 'bg-orange-500', 'bg-red-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800');
            });
            
            // تطبيق التحديد على الزر المختار
            button.classList.remove('bg-gray-200', 'text-gray-800');
            button.classList.add('selected', 'text-white');
            
            // تطبيق اللون المناسب للدرجة
            if (score === 5) button.classList.add('bg-green-500');
            else if (score === 4) button.classList.add('bg-blue-500');
            else if (score === 3) button.classList.add('bg-yellow-500');
            else if (score === 2) button.classList.add('bg-orange-500');
            else if (score === 1) button.classList.add('bg-red-500');
            
            // تحديث الحقل المخفي
            document.getElementById(`${criterion}Score`).value = score;
        }
        
        // تحميل التقييم السابق
        function loadPreviousEvaluation() {
            const evaluatorName = document.getElementById('evaluatorName').value;
            if (!evaluatorName || !appData.currentStudent) return;
            
            const previousEvaluation = appData.evaluations.find(eval => 
                eval.studentId === appData.currentStudent.id && eval.evaluatorName === evaluatorName
            );
            
            if (previousEvaluation) {
                // تعبئة النموذج بالتقييم السابق
                document.getElementById('preparationScore').value = previousEvaluation.preparationScore;
                document.getElementById('diversityScore').value = previousEvaluation.diversityScore;
                document.getElementById('clarityScore').value = previousEvaluation.clarityScore;
                document.getElementById('deliveryScore').value = previousEvaluation.deliveryScore;
                
                // تحديث أزرار التقييم
                updateScoreButtons('preparation', previousEvaluation.preparationScore);
                updateScoreButtons('diversity', previousEvaluation.diversityScore);
                updateScoreButtons('clarity', previousEvaluation.clarityScore);
                updateScoreButtons('delivery', previousEvaluation.deliveryScore);
                
                // حفظ معرف التقييم للتحديث لاحقاً
                appData.currentEvaluation = previousEvaluation;
                
                showMessage('تم التحميل', 'تم تحميل التقييم السابق بنجاح!', 'success');
            } else {
                // إعادة تعيين النموذج لتقييم جديد
                document.getElementById('preparationScore').value = '';
                document.getElementById('diversityScore').value = '';
                document.getElementById('clarityScore').value = '';
                document.getElementById('deliveryScore').value = '';
                
                document.querySelectorAll('.score-btn').forEach(btn => {
                    btn.classList.remove('selected', 'bg-green-500', 'bg-blue-500', 'bg-yellow-500', 'bg-orange-500', 'bg-red-500', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-800');
                });
                
                appData.currentEvaluation = null;
            }
        }
        
        // تحديث أزرار التقييم
        function updateScoreButtons(criterion, score) {
            document.querySelectorAll(`.score-btn[data-criterion="${criterion}"]`).forEach(btn => {
                btn.classList.remove('selected', 'bg-green-500', 'bg-blue-500', 'bg-yellow-500', 'bg-orange-500', 'bg-red-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800');
                
                if (parseInt(btn.getAttribute('data-score')) === score) {
                    btn.classList.remove('bg-gray-200', 'text-gray-800');
                    btn.classList.add('selected', 'text-white');
                    
                    if (score === 5) btn.classList.add('bg-green-500');
                    else if (score === 4) btn.classList.add('bg-blue-500');
                    else if (score === 3) btn.classList.add('bg-yellow-500');
                    else if (score === 2) btn.classList.add('bg-orange-500');
                    else if (score === 1) btn.classList.add('bg-red-500');
                }
            });
        }
        
        // معالجة تقديم التقييم
        function handleEvaluationSubmit(e) {
            e.preventDefault();
            
            const evaluatorName = document.getElementById('evaluatorName').value;
            const preparationScore = document.getElementById('preparationScore').value;
            const diversityScore = document.getElementById('diversityScore').value;
            const clarityScore = document.getElementById('clarityScore').value;
            const deliveryScore = document.getElementById('deliveryScore').value;
            
            if (!evaluatorName || !preparationScore || !diversityScore || !clarityScore || !deliveryScore) {
                showMessage('خطأ', 'يرجى ملء جميع الحقول وتقييم جميع المعايير!', 'error');
                return;
            }
            
            const evaluationData = {
                id: appData.currentEvaluation ? appData.currentEvaluation.id : Date.now().toString(),
                studentId: appData.currentStudent.id,
                evaluatorName: evaluatorName,
                preparationScore: parseInt(preparationScore),
                diversityScore: parseInt(diversityScore),
                clarityScore: parseInt(clarityScore),
                deliveryScore: parseInt(deliveryScore),
                evaluationDate: new Date().toISOString()
            };
            
            if (appData.currentEvaluation) {
                // تحديث التقييم الحالي
                const index = appData.evaluations.findIndex(eval => eval.id === appData.currentEvaluation.id);
                if (index !== -1) {
                    appData.evaluations[index] = evaluationData;
                }
            } else {
                // إضافة تقييم جديد
                appData.evaluations.push(evaluationData);
            }
            
            saveAppData();
            
            // تحديث سجل التقييمات
            loadEvaluationHistory(appData.currentStudent.id);
            
            showMessage('نجاح', 'تم حفظ التقييم بنجاح!', 'success');
        }
        
        // تحميل سجل التقييمات
        function loadEvaluationHistory(studentId) {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            const studentEvaluations = appData.evaluations.filter(eval => eval.studentId === studentId);
            
            if (studentEvaluations.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-500 py-4">لا توجد تقييمات سابقة</p>';
                return;
            }
            
            // فرز التقييمات حسب التاريخ (الأحدث أولاً)
            studentEvaluations.sort((a, b) => new Date(b.evaluationDate) - new Date(a.evaluationDate));
            
            studentEvaluations.forEach(evaluation => {
                const averageScore = (evaluation.preparationScore + evaluation.diversityScore + 
                                    evaluation.clarityScore + evaluation.deliveryScore) / 4;
                
                const historyItem = document.createElement('div');
                historyItem.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
                historyItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-gray-800">${evaluation.evaluatorName}</h4>
                            <p class="text-sm text-gray-600">${new Date(evaluation.evaluationDate).toLocaleDateString('ar-EG')}</p>
                        </div>
                        <div class="text-right">
                            <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm font-medium">
                                متوسط: ${averageScore.toFixed(1)}/5
                            </span>
                        </div>
                    </div>
                    <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                        <div>الإعداد: ${getScoreText(evaluation.preparationScore)}</div>
                        <div>التنوع: ${getScoreText(evaluation.diversityScore)}</div>
                        <div>الوضوح: ${getScoreText(evaluation.clarityScore)}</div>
                        <div>الإلقاء: ${getScoreText(evaluation.deliveryScore)}</div>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }
        
        // الحصول على نص الدرجة
        function getScoreText(score) {
            switch(score) {
                case 5: return 'ممتاز';
                case 4: return 'جيد جداً';
                case 3: return 'جيد';
                case 2: return 'مقبول';
                case 1: return 'ضعيف';
                default: return 'غير محدد';
            }
        }
        
        // إظهار نموذج الإعدادات
        function showSettingsModal() {
            document.getElementById('pdfTitle').value = appData.settings.pdfTitle;
            document.getElementById('pdfFooter').value = appData.settings.pdfFooter;
            document.getElementById('appPassword').value = appData.settings.password;
            document.getElementById('evaluatorNames').value = appData.settings.evaluators.join(', ');
            
            document.getElementById('settingsModal').classList.remove('hidden');
        }
        
        // إخفاء نموذج الإعدادات
        function hideSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }
        
        // حفظ الإعدادات
        function saveSettings() {
            appData.settings.pdfTitle = document.getElementById('pdfTitle').value;
            appData.settings.pdfFooter = document.getElementById('pdfFooter').value;
            appData.settings.password = document.getElementById('appPassword').value;
            
            const evaluatorsText = document.getElementById('evaluatorNames').value;
            appData.settings.evaluators = evaluatorsText.split(',').map(name => name.trim()).filter(name => name);
            
            saveAppData();
            updateEvaluatorsList();
            
            hideSettingsModal();
            showMessage('نجاح', 'تم حفظ الإعدادات بنجاح!', 'success');
        }
        
        // تحديث قائمة المقيّمين
        function updateEvaluatorsList() {
            const evaluatorSelect = document.getElementById('evaluatorName');
            evaluatorSelect.innerHTML = '<option value="">اختر المقيّم</option>';
            
            appData.settings.evaluators.forEach(evaluator => {
                const option = document.createElement('option');
                option.value = evaluator;
                option.textContent = evaluator;
                evaluatorSelect.appendChild(option);
            });
        }
        
        // إظهار نموذج تصدير التطبيق
        function showExportAppModal() {
            document.getElementById('exportAppModal').classList.remove('hidden');
        }
        
        // إخفاء نموذج تصدير التطبيق
        function hideExportAppModal() {
            document.getElementById('exportAppModal').classList.add('hidden');
        }
        
        // تصدير التطبيق
        function exportApp() {
            const fileName = document.getElementById('exportFileName').value || 'تطبيق_تقييم_الطلاب';
            
            // إنشاء محتوى HTML كامل للتطبيق
            const appContent = document.documentElement.outerHTML;
            
            // إنشاء رابط تحميل
            const blob = new Blob([appContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            hideExportAppModal();
            showMessage('نجاح', 'تم تصدير التطبيق بنجاح!', 'success');
        }
        
        // إظهار معاينة PDF للطالب
        function showStudentPdfPreview() {
            if (!appData.currentStudent) return;
            
            openStudentPdfPreview(appData.currentStudent.id);
        }
        
        // فتح معاينة PDF للطالب
        function openStudentPdfPreview(studentId) {
            const student = appData.students.find(s => s.id === studentId);
            if (!student) return;
            
            // تعبئة بيانات الطالب
            document.getElementById('reportStudentName').textContent = student.name;
            document.getElementById('reportStudentGrade').textContent = student.grade;
            document.getElementById('reportStudentClass').textContent = student.class;
            document.getElementById('reportStudentSection').textContent = student.section;
            document.getElementById('reportStudentGroup').textContent = student.group;
            document.getElementById('reportBroadcastDate').textContent = student.broadcastDate;
            document.getElementById('reportDate').textContent = `تاريخ التقرير: ${new Date().toLocaleDateString('ar-EG')}`;
            document.getElementById('reportTitle').textContent = appData.settings.pdfTitle;
            document.getElementById('reportFooter').textContent = appData.settings.pdfFooter;
            
            // الحصول على تقييمات الطالب
            const studentEvaluations = appData.evaluations.filter(eval => eval.studentId === studentId);
            
            // حساب نتائج التقييمات لكل معيار
            const preparationScores = studentEvaluations.map(eval => eval.preparationScore);
            const diversityScores = studentEvaluations.map(eval => eval.diversityScore);
            const clarityScores = studentEvaluations.map(eval => eval.clarityScore);
            const deliveryScores = studentEvaluations.map(eval => eval.deliveryScore);
            
            // تحديد التقييم الأكثر تكراراً لكل معيار
            const preparationResult = getMostFrequentScore(preparationScores);
            const diversityResult = getMostFrequentScore(diversityScores);
            const clarityResult = getMostFrequentScore(clarityScores);
            const deliveryResult = getMostFrequentScore(deliveryScores);
            
            // تعبئة الجدول بنتائج التقييم
            fillScoreTable('preparation', preparationResult);
            fillScoreTable('diversity', diversityResult);
            fillScoreTable('clarity', clarityResult);
            fillScoreTable('delivery', deliveryResult);
            
            // تعبئة أسماء المقيّمين
            const evaluators = [...new Set(studentEvaluations.map(eval => eval.evaluatorName))];
            document.getElementById('reportEvaluators').textContent = evaluators.join('، ');
            
            document.getElementById('studentPdfPreview').classList.remove('hidden');
        }
        
        // الحصول على الدرجة الأكثر تكراراً
        function getMostFrequentScore(scores) {
            if (scores.length === 0) return { score: 0, count: 0 };
            
            const frequency = {};
            let maxCount = 0;
            let mostFrequent = scores[0];
            
            for (const score of scores) {
                frequency[score] = (frequency[score] || 0) + 1;
                if (frequency[score] > maxCount) {
                    maxCount = frequency[score];
                    mostFrequent = score;
                }
            }
            
            return { score: mostFrequent, count: maxCount };
        }
        
        // تعبئة جدول النتائج
        function fillScoreTable(criterion, result) {
            const score = result.score;
            
            // إعادة تعيين جميع الخلايا
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`${criterion}${getScoreTextByNumber(i)}`).textContent = '';
            }
            
            // تعبئة الخلية المناسبة
            if (score > 0) {
                document.getElementById(`${criterion}${getScoreTextByNumber(score)}`).textContent = '✓';
            }
        }
        
        // الحصول على نص الدرجة حسب الرقم
        function getScoreTextByNumber(score) {
            switch(score) {
                case 5: return 'Excellent';
                case 4: return 'VeryGood';
                case 3: return 'Good';
                case 2: return 'Acceptable';
                case 1: return 'Weak';
                default: return '';
            }
        }
        
        // إخفاء معاينة PDF للطالب
        function hideStudentPdfPreview() {
            document.getElementById('studentPdfPreview').classList.add('hidden');
        }
        
        // إنشاء PDF للطالب
        function generateStudentPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // إضافة محتوى PDF
            doc.setFontSize(18);
            doc.text(appData.settings.pdfTitle, 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`تاريخ التقرير: ${new Date().toLocaleDateString('ar-EG')}`, 105, 30, { align: 'center' });
            
            // معلومات الطالب
            doc.setFontSize(14);
            doc.text('معلومات الطالب', 20, 50);
            doc.setFontSize(12);
            doc.text(`اسم الطالب: ${appData.currentStudent.name}`, 20, 60);
            doc.text(`الصف الدراسي: ${appData.currentStudent.grade}`, 20, 67);
            doc.text(`الشعبة: ${appData.currentStudent.class}`, 20, 74);
            doc.text(`القسم: ${appData.currentStudent.section}`, 20, 81);
            doc.text(`المجموعة: ${appData.currentStudent.group}`, 20, 88);
            doc.text(`تاريخ الإذاعة: ${appData.currentStudent.broadcastDate}`, 20, 95);
            
            // نتائج التقييم
            doc.setFontSize(14);
            doc.text('نتيجة التقييم', 20, 115);
            
            // إنشاء جدول النتائج
            const head = [['عناصر التقييم', 'ممتاز', 'جيد جداً', 'جيد', 'مقبول', 'ضعيف']];
            const body = [
                ['الإعداد الجيد', '', '', '', '', ''],
                ['التنوع', '', '', '', '', ''],
                ['وضوح الرسالة الموجهة', '', '', '', '', ''],
                ['جودة الإلقاء', '', '', '', '', '']
            ];
            
            // الحصول على تقييمات الطالب
            const studentEvaluations = appData.evaluations.filter(eval => eval.studentId === appData.currentStudent.id);
            
            // حساب نتائج التقييمات لكل معيار
            const preparationScores = studentEvaluations.map(eval => eval.preparationScore);
            const diversityScores = studentEvaluations.map(eval => eval.diversityScore);
            const clarityScores = studentEvaluations.map(eval => eval.clarityScore);
            const deliveryScores = studentEvaluations.map(eval => eval.deliveryScore);
            
            // تحديد التقييم الأكثر تكراراً لكل معيار
            const preparationResult = getMostFrequentScore(preparationScores);
            const diversityResult = getMostFrequentScore(diversityScores);
            const clarityResult = getMostFrequentScore(clarityScores);
            const deliveryResult = getMostFrequentScore(deliveryScores);
            
            // تعبئة الجدول بنتائج التقييم
            if (preparationResult.score > 0) {
                body[0][6 - preparationResult.score] = "✓";
            }
            if (diversityResult.score > 0) {
                body[1][6 - diversityResult.score] = "✓";
            }
            if (clarityResult.score > 0) {
                body[2][6 - clarityResult.score] = "✓";
            }
            if (deliveryResult.score > 0) {
                body[3][6 - deliveryResult.score] = "✓";
            }
            
            // إضافة الجدول إلى PDF
            doc.autoTable({
                startY: 125,
                head: head,
                body: body,
                theme: 'grid',
                styles: { halign: 'center', font: 'helvetica' },
                headStyles: { fillColor: [102, 126, 234] }
            });
            
            // لجنة التقييم
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(14);
            doc.text('لجنة التقييم', 20, finalY);
            doc.setFontSize(12);
            
            const evaluators = [...new Set(studentEvaluations.map(eval => eval.evaluatorName))];
            doc.text(evaluators.join('، '), 20, finalY + 10);
            
            // تذييل الصفحة
            doc.setFontSize(10);
            doc.text(appData.settings.pdfFooter, 105, 280, { align: 'center' });
            
            // حفظ PDF
            doc.save(`تقرير_${appData.currentStudent.name}.pdf`);
            
            hideStudentPdfPreview();
        }
        
        // إظهار تقرير جميع الطلاب
        function showAllStudentsReport() {
            document.getElementById('allReportDate').textContent = `تاريخ التقرير: ${new Date().toLocaleDateString('ar-EG')}`;
            
            const studentsReportsList = document.getElementById('studentsReportsList');
            studentsReportsList.innerHTML = '';
            
            // الحصول على جميع المقيّمين
            const allEvaluators = [...new Set(appData.evaluations.map(eval => eval.evaluatorName))];
            document.getElementById('allReportEvaluators').textContent = allEvaluators.join('، ');
            
            // إضافة تقرير لكل طالب
            appData.students.forEach(student => {
                const studentEvaluations = appData.evaluations.filter(eval => eval.studentId === student.id);
                
                if (studentEvaluations.length === 0) return;
                
                const studentReport = document.createElement('div');
                studentReport.className = 'border border-gray-300 p-4 rounded-lg';
                
                // حساب متوسط التقييم للطالب
                let totalAverage = 0;
                studentEvaluations.forEach(eval => {
                    totalAverage += (eval.preparationScore + eval.diversityScore + eval.clarityScore + eval.deliveryScore) / 4;
                });
                const averageScore = totalAverage / studentEvaluations.length;
                
                studentReport.innerHTML = `
                    <h3 class="text-lg font-semibold mb-2">${student.name}</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                        <div><strong>الصف:</strong> ${student.grade}</div>
                        <div><strong>الشعبة:</strong> ${student.class}</div>
                        <div><strong>القسم:</strong> ${student.section}</div>
                        <div><strong>المجموعة:</strong> ${student.group}</div>
                    </div>
                    <div class="mb-2">
                        <strong>متوسط التقييم:</strong> 
                        <span class="${averageScore >= 4 ? 'text-green-600' : averageScore >= 3 ? 'text-yellow-600' : 'text-red-600'} font-medium">
                            ${averageScore.toFixed(1)}/5
                        </span>
                    </div>
                    <div class="text-sm text-gray-600">
                        <strong>عدد التقييمات:</strong> ${studentEvaluations.length}
                    </div>
                `;
                
                studentsReportsList.appendChild(studentReport);
            });
            
            document.getElementById('allStudentsPdfPreview').classList.remove('hidden');
        }
        
        // إخفاء معاينة PDF لجميع الطلاب
        function hideAllStudentsPdfPreview() {
            document.getElementById('allStudentsPdfPreview').classList.add('hidden');
        }
        
        // إنشاء PDF لجميع الطلاب
        function generateAllStudentsPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            let yPosition = 20;
            
            // عنوان التقرير
            doc.setFontSize(18);
            doc.text('تقرير تقييم جميع الطلاب', 105, yPosition, { align: 'center' });
            yPosition += 10;
            
            doc.setFontSize(12);
            doc.text(`تاريخ التقرير: ${new Date().toLocaleDateString('ar-EG')}`, 105, yPosition, { align: 'center' });
            yPosition += 20;
            
            // إضافة تقرير لكل طالب
            appData.students.forEach((student, index) => {
                const studentEvaluations = appData.evaluations.filter(eval => eval.studentId === student.id);
                
                if (studentEvaluations.length === 0) return;
                
                // التحقق إذا كانت الصفحة ممتلئة
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // معلومات الطالب
                doc.setFontSize(14);
                doc.text(student.name, 20, yPosition);
                yPosition += 7;
                
                doc.setFontSize(10);
                doc.text(`الصف: ${student.grade} - الشعبة: ${student.class} - القسم: ${student.section} - المجموعة: ${student.group}`, 20, yPosition);
                yPosition += 5;
                
                // حساب متوسط التقييم للطالب
                let totalAverage = 0;
                studentEvaluations.forEach(eval => {
                    totalAverage += (eval.preparationScore + eval.diversityScore + eval.clarityScore + eval.deliveryScore) / 4;
                });
                const averageScore = totalAverage / studentEvaluations.length;
                
                doc.text(`متوسط التقييم: ${averageScore.toFixed(1)}/5 - عدد التقييمات: ${studentEvaluations.length}`, 20, yPosition);
                yPosition += 10;
                
                // خط فاصل
                doc.line(20, yPosition, 190, yPosition);
                yPosition += 15;
            });
            
            // حفظ PDF
            doc.save('تقرير_جميع_الطلاب.pdf');
            
            hideAllStudentsPdfPreview();
        }
        
        // إظهار رسالة
        function showMessage(title, text, type) {
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageText').textContent = text;
            
            const messageHeader = document.getElementById('messageHeader');
            if (type === 'success') {
                messageHeader.className = 'p-6 border-b bg-green-100 border-green-200';
                document.getElementById('messageTitle').className = 'text-2xl font-bold text-green-800';
            } else if (type === 'error') {
                messageHeader.className = 'p-6 border-b bg-red-100 border-red-200';
                document.getElementById('messageTitle').className = 'text-2xl font-bold text-red-800';
            } else {
                messageHeader.className = 'p-6 border-b bg-blue-100 border-blue-200';
                document.getElementById('messageTitle').className = 'text-2xl font-bold text-blue-800';
            }
            
            document.getElementById('messageModal').classList.remove('hidden');
        }
        
        // إخفاء رسالة
        function hideMessageModal() {
            document.getElementById('messageModal').classList.add('hidden');
        }
    </script>
</body>
</html>