<html lang="ar" dir="rtl"><head><script>(function(firebaseConfig, initialAuthToken, appId) {
        window.__firebase_config = firebaseConfig;
        window.__initial_auth_token = initialAuthToken;
        window.__app_id = appId;
            })("\n{\n  \"apiKey\": \"AIzaSyCqyCcs2R2e7AegGjvFAwG98wlamtbHvZY\",\n  \"authDomain\": \"bard-frontend.firebaseapp.com\",\n  \"projectId\": \"bard-frontend\",\n  \"storageBucket\": \"bard-frontend.firebasestorage.app\",\n  \"messagingSenderId\": \"175205271074\",\n  \"appId\": \"1:175205271074:web:2b7bd4d34d33bf38e6ec7b\"\n}\n","eyJhbGciOiJSUzI1NiIsImtpZCI6ImQzNTlhZTBjMTczYzc3YjFjZDU1MjFiMjVhMWY2YTQ5ZWU1YTZkMjQiLCJ0eXAiOiJKV1QifQ.eyJzdWIiOiJmaXJlYmFzZS1hZG1pbnNkay1mYnN2Y0BiYXJkLWZyb250ZW5kLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwiYXVkIjoiaHR0cHM6Ly9pZGVudGl0eXRvb2xraXQuZ29vZ2xlYXBpcy5jb20vZ29vZ2xlLmlkZW50aXR5LmlkZW50aXR5dG9vbGtpdC52MS5JZGVudGl0eVRvb2xraXQiLCJ1aWQiOiIwODYxOTQxNTQyMDg5MDI2Mjk2NyIsImlzcyI6ImZpcmViYXNlLWFkbWluc2RrLWZic3ZjQGJhcmQtZnJvbnRlbmQuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJjbGFpbXMiOnsiYXBwSWQiOiJjXzQ4ODU1MzJkN2MzYzUyODZfc3R1ZGVudF9ldmFsdWF0aW9uX2FwcC5odG1sLTgxMSJ9LCJleHAiOjE3NjI1ODI2MDQsImlhdCI6MTc2MjU3OTAwNCwiYWxnIjoiUlMyNTYifQ.DCW2BjlXdrlUq196RuAHpyadKYC3gsuHWsv9LemS7ZAi5l5iWJAQ8fEpZvii-vxzcihfFc8oLKgO15GYW9Vg7EEOmBcQu0I36-3qSeh74ajEpfjjwTPxB-YMO8tI0OkhAGZ7qnmlTEoMK7Fe--ad8I0-wzGSXftwUCn2xQF1k7p2IyUqU7WmSiea3HNwqEkpwFypGghP74K3BjT8vIPR9GD2M-5Id3opM3RSKgMC48DdizP1OP3SgR6GIcvMJGfMsH9XfCDccJGseW4WbXJ4ruOyiAYYPAdBN0T4L2G9pDdP9i_eK5cI9sdRPRZ9pjhxRJ2AtCPCQ9P3WT27XAdfww","c_4885532d7c3c5286_student_evaluation_app.html-811")</script><script>'use strict';var h=typeof Object.defineProperties=="function"?Object.defineProperty:function(a,b,d){if(a==Array.prototype||a==Object.prototype)return a;a[b]=d.value;return a};function l(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var d=a[b];if(d&&d.Math==Math)return d}throw Error("Cannot find global object");}var n=l(this);
function p(a,b){if(b)a:{var d=n;a=a.split(".");for(var c=0;c<a.length-1;c++){var e=a[c];if(!(e in d))break a;d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&b!=null&&h(d,a,{configurable:!0,writable:!0,value:b})}}function r(a){function b(c){return a.next(c)}function d(c){return a.throw(c)}return new Promise(function(c,e){function f(g){g.done?c(g.value):Promise.resolve(g.value).then(b,d).then(f,e)}f(a.next())})}function t(a){return r(a())}
p("Object.values",function(a){return a?a:function(b){var d=[],c;for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&d.push(b[c]);return d}});p("Array.prototype.includes",function(a){return a?a:function(b,d){var c=this;c instanceof String&&(c=String(c));var e=c.length;d=d||0;for(d<0&&(d=Math.max(d+e,0));d<e;d++){var f=c[d];if(f===b||Object.is(f,b))return!0}return!1}});/*

 MIT License

 Copyright (c) 2017-2023 W.Y.

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 SOFTWARE.

*/
function u(a,b){const d=a.style;b.backgroundColor&&(d.backgroundColor=b.backgroundColor);b.width&&(d.width=`${b.width}px`);b.height&&(d.height=`${b.height}px`);const c=b.style;c!=null&&Object.keys(c).forEach(e=>{d[e]=c[e]})};var v=(()=>{let a=0;return()=>{a+=1;return`u${`0000${(Math.random()*1679616<<0).toString(36)}`.slice(-4)}${a}`}})();function w(a){const b=[];for(let d=0,c=a.length;d<c;d++)b.push(a[d]);return b}let x=null;function y(a={}){return x?x:a.l?x=a.l:x=w(window.getComputedStyle(document.documentElement))}function z(a,b){return(a=(a.ownerDocument.defaultView||window).getComputedStyle(a).getPropertyValue(b))?parseFloat(a.replace("px","")):0}
function A(a,b={}){var d;if(!(d=b.width)){d=z(a,"border-left-width");var c=z(a,"border-right-width");d=a.clientWidth+d+c}(b=b.height)||(b=z(a,"border-top-width"),c=z(a,"border-bottom-width"),b=a.clientHeight+b+c);return{width:d,height:b}}function B(a){return new Promise((b,d)=>{const c=new Image;c.onload=()=>{c.decode().then(()=>{requestAnimationFrame(()=>b(c))})};c.onerror=d;c.crossOrigin="anonymous";c.decoding="async";c.src=a})}
function C(a){return t(function*(){return Promise.resolve().then(()=>(new XMLSerializer).serializeToString(a)).then(encodeURIComponent).then(b=>`data:image/svg+xml;charset=utf-8,${b}`)})}
function D(a,b,d){return t(function*(){const c=document.createElementNS("http://www.w3.org/2000/svg","svg"),e=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");c.setAttribute("width",`${b}`);c.setAttribute("height",`${d}`);c.setAttribute("viewBox",`0 0 ${b} ${d}`);e.setAttribute("width","100%");e.setAttribute("height","100%");e.setAttribute("x","0");e.setAttribute("y","0");e.setAttribute("externalResourcesRequired","true");c.appendChild(e);e.appendChild(a);return C(c)})}
var E=(a,b)=>{if(a instanceof b)return!0;a=Object.getPrototypeOf(a);return a===null?!1:a.constructor.name===b.name||E(a,b)};function F(a,b){return y(b).map(d=>{const c=a.getPropertyValue(d),e=a.getPropertyPriority(d);return`${d}: ${c}${e?" !important":""};`}).join(" ")}
function G(a,b,d,c){a=window.getComputedStyle(a,d);var e=a.getPropertyValue("content");if(e!==""&&e!=="none"){var f=v();try{b.className=`${b.className} ${f}`}catch(k){return}e=document.createElement("style");var g=e.appendChild;d=`.${f}:${d}`;a.cssText?(c=a.getPropertyValue("content"),c=`${a.cssText} content: '${c.replace(/'|"/g,"")}';`):c=F(a,c);g.call(e,document.createTextNode(`${d}{${c}}`));b.appendChild(e)}};function H(a){return a.search(/^(data:)/)!==-1}function I(a,b,d){return t(function*(){const c=yield fetch(a,b);if(c.status===404)throw Error(`Resource "${c.url}" not found`);const e=yield c.blob();return new Promise((f,g)=>{const k=new FileReader;k.onerror=g;k.onloadend=()=>{try{f(d({o:c,result:k.result}))}catch(m){g(m)}};k.readAsDataURL(e)})})}const J={};function K(a,b,d){let c=a.replace(/\?.*/,"");d&&(c=a);/ttf|otf|eot|woff2?/i.test(c)&&(c=c.replace(/.*\//,""));return b?`[${b}]${c}`:c}
function L(a,b,d){return t(function*(){const c=K(a,b,d.C);if(J[c]!=null)return J[c];d.u&&(a+=(/\?/.test(a)?"&":"?")+(new Date).getTime());let e;try{const f=yield I(a,d.i,({o:g,result:k})=>{b||(b=g.headers.get("Content-Type")||"");return k.split(/,/)[1]});e=`data:${b};base64,${f}`}catch(f){e=d.B||""}return J[c]=e})};const M={P:"application/font-woff",R:"application/font-woff",N:"application/font-truetype",v:"application/vnd.ms-fontobject",H:"image/png",F:"image/jpeg",D:"image/jpeg",A:"image/gif",M:"image/tiff",L:"image/svg+xml",O:"image/webp"};function N(a){return(a=/\.([^./]*?)$/g.exec(a))?a[1]:""};function O(a){return t(function*(){const b=a.toDataURL();return b==="data:,"?a.cloneNode(!1):B(b)})}function aa(a,b){return t(function*(){if(a.currentSrc){var d=document.createElement("canvas");const c=d.getContext("2d");d.width=a.clientWidth;d.height=a.clientHeight;c==null||c.drawImage(a,0,0,d.width,d.height);d=d.toDataURL();return B(d)}d=a.poster;d=yield L(d,M[N(d).toLowerCase()]||"",b);return B(d)})}
function ba(a,b){return t(function*(){try{let d;if(a==null?0:(d=a.contentDocument)==null?0:d.body)return yield P(a.contentDocument.body,b,!0)}catch(d){}return a.cloneNode(!1)})}function ca(a,b){return t(function*(){return E(a,HTMLCanvasElement)?O(a):E(a,HTMLVideoElement)?aa(a,b):E(a,HTMLIFrameElement)?ba(a,b):a.cloneNode(a.tagName!=null&&a.tagName.toUpperCase()==="SVG")})}
function da(a,b,d){return t(function*(){if(b.tagName!=null&&b.tagName.toUpperCase()==="SVG")return b;let c=[];if(a.tagName!=null&&a.tagName.toUpperCase()==="SLOT"&&a.assignedNodes)c=w(a.assignedNodes());else{let e;if(E(a,HTMLIFrameElement)&&((e=a.contentDocument)==null?0:e.body))c=w(a.contentDocument.body.childNodes);else{let f;c=w(((f=a.shadowRoot)!=null?f:a).childNodes)}}if(c.length===0||E(a,HTMLVideoElement))return b;yield c.reduce((e,f)=>e.then(()=>P(f,d)).then(g=>{g&&b.appendChild(g)}),Promise.resolve());
return b})}function ea(a,b,d){const c=b.style;if(c){var e=window.getComputedStyle(a);e.cssText?(c.cssText=e.cssText,c.transformOrigin=e.transformOrigin):y(d).forEach(f=>{let g=e.getPropertyValue(f);f==="font-size"&&g.endsWith("px")&&(g=`${Math.floor(parseFloat(g.substring(0,g.length-2)))-.1}px`);E(a,HTMLIFrameElement)&&f==="display"&&g==="inline"&&(g="block");f==="d"&&b.getAttribute("d")&&(g=`path(${b.getAttribute("d")})`);c.setProperty(f,g,e.getPropertyPriority(f))})}}
function fa(a,b){E(a,HTMLSelectElement)&&(b=Array.from(b.children).find(d=>a.value===d.getAttribute("value")))&&b.setAttribute("selected","")}
function ha(a,b){return t(function*(){var d=a.querySelectorAll?a.querySelectorAll("use"):[];if(d.length===0)return a;var c={};for(var e=0;e<d.length;e++){var f=d[e].getAttribute("xlink:href");if(f){const g=document.querySelector(f);a.querySelector(f)||!g||c[f]||(c[f]=yield P(g,b,!0))}}d=Object.values(c);if(d.length){c=document.createElementNS("http://www.w3.org/1999/xhtml","svg");c.setAttribute("xmlns","http://www.w3.org/1999/xhtml");c.style.position="absolute";c.style.width="0";c.style.height="0";
c.style.overflow="hidden";c.style.display="none";e=document.createElementNS("http://www.w3.org/1999/xhtml","defs");c.appendChild(e);for(f=0;f<d.length;f++)e.appendChild(d[f]);a.appendChild(c)}return a})}
function P(a,b,d){return t(function*(){return d||!b.filter||b.filter(a)?Promise.resolve(a).then(c=>ca(c,b)).then(c=>da(a,c,b)).then(c=>{E(c,Element)&&(ea(a,c,b),G(a,c,":before",b),G(a,c,":after",b),E(a,HTMLTextAreaElement)&&(c.textContent=a.value),E(a,HTMLInputElement)&&c.setAttribute("value",a.value),fa(a,c));return c}).then(c=>ha(c,b)):null})};const Q=/url\((['"]?)([^'"]+?)\1\)/g,ia=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,ja=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function ka(a){const b=[];a.replace(Q,(d,c,e)=>{b.push(e);return d});return b.filter(d=>!H(d))}
function la(a,b,d,c){return t(function*(){try{const e=d?(new URL(b,d||void 0)).toString():b;let f;f=yield L(e,M[N(b).toLowerCase()]||"",c);return a.replace(new RegExp(`(url\\(['"]?)(${b.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")})(['"]?\\))`,"g"),`$1${f}$3`)}catch(e){}return a})}function ma(a,{I:b}){return b?a.replace(ja,d=>{for(;;){const [c,,e]=ia.exec(d)||[],f=c,g=e;if(!g)return"";if(g===b)return`src: ${f};`}}):a}
function R(a,b,d){return t(function*(){if(a.search(Q)===-1)return a;const c=ma(a,d);return ka(c).reduce((e,f)=>e.then(g=>la(g,f,b,d)),Promise.resolve(c))})};function S(a,b,d){return t(function*(){var c;const e=(c=b.style)==null?void 0:c.getPropertyValue(a);return e?(c=yield R(e,null,d),b.style.setProperty(a,c,b.style.getPropertyPriority(a)),!0):!1})}function na(a,b){return t(function*(){(yield S("background",a,b))||(yield S("background-image",a,b));(yield S("mask",a,b))||(yield S("-webkit-mask",a,b))||(yield S("mask-image",a,b))||(yield S("-webkit-mask-image",a,b))})}
function oa(a,b){return t(function*(){const d=E(a,HTMLImageElement);if(d&&!H(a.src)||E(a,SVGImageElement)&&!H(a.href.baseVal)){var c=d?a.src:a.href.baseVal,e=yield L(c,M[N(c).toLowerCase()]||"",b);yield new Promise((f,g)=>{a.onload=f;a.onerror=b.m?(...k)=>{try{f(b.m(...k))}catch(m){g(m)}}:g;a.decode&&(a.decode=f);a.loading==="lazy"&&(a.loading="eager");d?(a.srcset="",a.src=e):a.href.baseVal=e})}})}
function pa(a,b){return t(function*(){const d=w(a.childNodes).map(c=>T(c,b));yield Promise.all(d).then(()=>a)})}function T(a,b){return t(function*(){E(a,Element)&&(yield na(a,b),yield oa(a,b),yield pa(a,b))})};const U={};function V(a){return t(function*(){var b=U[a];if(b!=null)return b;b=yield(yield fetch(a)).text();b={url:a,cssText:b};return U[a]=b})}function W(a,b){return t(function*(){let d=a.cssText;const c=/url\(["']?([^"')]+)["']?\)/g,e=(d.match(/url\([^)]+\)/g)||[]).map(f=>t(function*(){let g=f.replace(c,"$1");g.startsWith("https://")||(g=(new URL(g,a.url)).href);return I(g,b.i,({result:k})=>{d=d.replace(f,`url(${k})`);return[f,k]})}));return Promise.all(e).then(()=>d)})}
function X(a){if(a==null)return[];const b=[];a=a.replace(/(\/\*[\s\S]*?\*\/)/gi,"");for(var d=RegExp("((@.*?keyframes [\\s\\S]*?){([\\s\\S]*?}\\s*?)})","gi");;){var c=d.exec(a);if(c===null)break;b.push(c[0])}a=a.replace(d,"");d=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi;for(c=RegExp("((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})","gi");;){let e=d.exec(a);if(e===null)if(e=c.exec(a),e===null)break;else d.lastIndex=c.lastIndex;else c.lastIndex=
d.lastIndex;b.push(e[0])}return b}
function qa(a,b){return t(function*(){const d=[],c=[];a.forEach(e=>{if("cssRules"in e)try{w(e.cssRules||[]).forEach((f,g)=>{if(f.type===CSSRule.IMPORT_RULE){let k=g+1;f=V(f.href).then(m=>W(m,b)).then(m=>X(m).forEach(q=>{try{e.insertRule(q,q.startsWith("@import")?k+=1:e.cssRules.length)}catch(Da){}})).catch(()=>{});c.push(f)}})}catch(f){const g=a.find(k=>k.href==null)||document.styleSheets[0];e.href!=null&&c.push(V(e.href).then(k=>W(k,b)).then(k=>X(k).forEach(m=>{g.insertRule(m,g.cssRules.length)})).catch(()=>
{}))}});return Promise.all(c).then(()=>{a.forEach(e=>{if("cssRules"in e)try{w(e.cssRules||[]).forEach(f=>{d.push(f)})}catch(f){}});return d})})}function ra(a){return a.filter(b=>b.type===CSSRule.FONT_FACE_RULE).filter(b=>b.style.getPropertyValue("src").search(Q)!==-1)}function sa(a,b){return t(function*(){if(a.ownerDocument==null)throw Error("Provided element is not within a Document");var d=w(a.ownerDocument.styleSheets);d=yield qa(d,b);return ra(d)})}
function ta(a){function b(c){(c.style.fontFamily||getComputedStyle(c).fontFamily).split(",").forEach(e=>{d.add(e.trim().replace(/["']/g,""))});Array.from(c.children).forEach(e=>{e instanceof HTMLElement&&b(e)})}const d=new Set;b(a);return d}function ua(a,b){return t(function*(){const d=yield sa(a,b),c=ta(a);return(yield Promise.all(d.filter(e=>c.has(e.style.fontFamily.trim().replace(/["']/g,""))).map(e=>R(e.cssText,e.parentStyleSheet?e.parentStyleSheet.href:null,b)))).join("\n")})}
function va(a,b){return t(function*(){const d=b.j!=null?b.j:b.K?null:yield ua(a,b);if(d){const c=document.createElement("style");c.appendChild(document.createTextNode(d));a.firstChild?a.insertBefore(c,a.firstChild):a.appendChild(c)}})};function wa(a,b={}){return t(function*(){const {width:d,height:c}=A(a,b),e=yield P(a,b,!0);yield va(e,b);yield T(e,b);u(e,b);return yield D(e,d,c)})}
function xa(a,b={}){return t(function*(){const {width:d,height:c}=A(a,b);var e=yield wa(a,b);e=yield B(e);const f=document.createElement("canvas"),g=f.getContext("2d"),k=b.G||window.devicePixelRatio||1,m=b.h||d,q=b.g||c;f.width=m*k;f.height=q*k;!b.J&&(f.width>16384||f.height>16384)&&(f.width>16384&&f.height>16384?f.width>f.height?(f.height*=16384/f.width,f.width=16384):(f.width*=16384/f.height,f.height=16384):f.width>16384?(f.height*=16384/f.width,f.width=16384):(f.width*=16384/f.height,f.height=
16384));f.style.width=`${m}`;f.style.height=`${q}`;b.backgroundColor&&(g.fillStyle=b.backgroundColor,g.fillRect(0,0,f.width,f.height));g.drawImage(e,0,0,f.width,f.height);return f})}function ya(a,b={}){return t(function*(){return(yield xa(a,b)).toDataURL()})};const za=["gemini.google.com","corp.google.com","proxy.googlers.com"];function Y(){return document.body.querySelectorAll('[class*="animate"]').length>0}function Z(a){return t(function*(){try{return yield ya(a,{h:a.offsetWidth,g:a.offsetHeight})}catch(d){var b=a.offsetHeight;const c=document.createElement("canvas");c.width=a.offsetWidth;c.height=b;return c.toDataURL("image/png")}})}
function Aa(){return t(function*(){const a=document.body.offsetWidth,b=document.body.offsetHeight,d=document.body.cloneNode(!0);d.querySelectorAll('[class*="animate"]').forEach(c=>{c.classList.remove(...Array.from(c.classList).filter(e=>e.startsWith("animate")))});d.style.width=`${a}px`;d.style.height=`${b}px`;return d})}
function Ba(a){return t(function*(){let b=document.body;if(Y()){var d=yield Aa();b=d;document.body.appendChild(d)}d=yield Z(b);Y()&&document.body.removeChild(b);window.parent.postMessage({type:"SEND_SCREENSHOT",image:d,topOffset:document.documentElement.scrollTop},a.origin)})}function Ca(a){return t(function*(){const b={type:"SEND_SCREENSHOT_FOR_DATA_VISUALIZATION",image:yield Z(document.body),topOffset:0};window.parent.postMessage(b,a.origin)})}
window.addEventListener("message",a=>t(function*(){if(za.some(d=>a.origin.includes(d))){var b=a.data;b&&(b.type==="MAKE_SCREENSHOT"&&(yield Ba(a)),b.type==="MAKE_SCREENSHOT_FOR_DATA_VISUALIZATION"&&(yield Ca(a)))}}));
</script><script>(function() {
  // Ensure this script is executed only once
  if (window.firebaseAuthBridgeScriptLoaded) {
    return;
  }
  window.firebaseAuthBridgeScriptLoaded = true;

  let nextTokenPromiseId = 0;

  // Stores { resolve, reject } for ongoing token requests
  const pendingTokenPromises = {};

  // Listen for messages from the Host Application
  window.addEventListener('message', function(event) {

    const messageData = event.data;

  if (messageData && messageData.type === 'RESOLVE_NEW_FIREBASE_TOKEN') {
      const { success, token, error, promiseId } = messageData ?? {};
      if (pendingTokenPromises[promiseId]) {
        if (success) {
          pendingTokenPromises[promiseId].resolve(token);
        } else {
          pendingTokenPromises[promiseId].reject(new Error(error || 'Token refresh failed from host.'));
        }
        delete pendingTokenPromises[promiseId];
      }
    }
  });

  // Expose a function for the Generated App to request a new Firebase token
  window.requestNewFirebaseToken = function() {
    const currentPromiseId = nextTokenPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingTokenPromises[currentPromiseId] = { resolve, reject };
    });
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({
        type: 'REQUEST_NEW_FIREBASE_TOKEN',
        promiseId: currentPromiseId
      }, '*');
    } else {
      pendingTokenPromises[currentPromiseId].reject(new Error('No parent window to request token from.'));
      delete pendingTokenPromises[currentPromiseId];
    }
    return promise;
  };
})();</script><script>
let realOriginalGetUserMedia = null;
if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
  realOriginalGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
}

(function() {
  if (navigator.mediaDevices && navigator.mediaDevices.__proto__) {
    try {
      Object.defineProperty(navigator.mediaDevices.__proto__, 'getUserMedia', {
        get: function() {
          return undefined; // Or throw an error
        },
        configurable: false
      });
    } catch (error) {
      console.error("Error defining prototype getter:", error);
    }
  }
})();

(function() {
  const pendingMediaResolvers = {};
  let nextMediaPromiseId = 0;

  function requestMediaPermissions(constraints) {
    const mediaPromiseId = nextMediaPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingMediaResolvers[mediaPromiseId] = (granted) => {
        delete pendingMediaResolvers[mediaPromiseId];
        resolve(granted);
      };
    });

    window.parent.postMessage({
      type: 'requestMediaPermission',
      constraints: constraints,
      promiseId: mediaPromiseId,
    }, '*');

    return promise;
  }

  let originalGetUserMedia = realOriginalGetUserMedia;

  function interceptGetUserMedia() {
    if (navigator.mediaDevices) {
      Object.defineProperty(navigator.mediaDevices, 'getUserMedia', {
        value: function(constraints) {
          return requestMediaPermissions(constraints).then((granted) => {
            if (granted) {
              if (originalGetUserMedia) {
                return originalGetUserMedia(constraints);
              } else {
                throw new Error("Original getUserMedia not available.");
              }
            } else {
              throw new DOMException('Permission denied', 'NotAllowedError');
            }
          });
        },
        writable: false,
        configurable: false
      });
    }
  }

  interceptGetUserMedia();

  const observer = new MutationObserver(function(mutationsList, observer) {
    for (const mutation of mutationsList) {
      if (mutation.type === 'reconfigured' && mutation.name === 'getUserMedia' && mutation.object === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'attributes' && mutation.attributeName === 'getUserMedia' && mutation.target === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'childList' && mutation.addedNodes) {
        mutation.addedNodes.forEach(node => {
          if (node === navigator.mediaDevices) {
            interceptGetUserMedia();
          }
        });
      }
    }
  });

  function interceptSpeechRecognition() {
    if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
      return;
    }

    const OriginalSpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    const SpeechRecognitionWrapper = function(...args) {
      const recognizer = new OriginalSpeechRecognition(...args);
      const originalStart = recognizer.start.bind(recognizer);

      recognizer.start = function() {
        requestMediaPermissions({ audio: true }).then(granted => {
          if (granted) {
            originalStart();
          } else {
            const errorEvent = new SpeechRecognitionErrorEvent('error');
            errorEvent.error = 'not-allowed'; // This is the standard error for permission denial.
            recognizer.dispatchEvent(errorEvent);
          }
        });
      };

      return recognizer;
    };

    SpeechRecognitionWrapper.prototype = OriginalSpeechRecognition.prototype;
    SpeechRecognitionWrapper.prototype.constructor = SpeechRecognitionWrapper;

    if (window.SpeechRecognition) {
      window.SpeechRecognition = SpeechRecognitionWrapper;
    }
    if (window.webkitSpeechRecognition) {
      window.webkitSpeechRecognition = SpeechRecognitionWrapper;
    }
  }

  interceptSpeechRecognition();

  window.addEventListener('message', function(event) {
    if (event.data) {
      if (event.data.type === 'resolveMediaPermission') {
        const { promiseId, granted } = event.data;
        if (pendingMediaResolvers[promiseId]) {
          pendingMediaResolvers[promiseId](granted);
        }
      }
    }
  });

})();</script><script>((function(modelInformation) {
  const originalFetch = window.fetch;
  // TODO: b/421908508 - Move these out of the script and match all generative AI model calls.
  let googleLlmBaseApiUrls = [
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':streamGenerateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageEditModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.ttsModelName + ':generateContent',
  ];
  modelInformation.deprecatedTextModelNames.forEach((modelName) => {
    googleLlmBaseApiUrls.push(
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':streamGenerateContent',
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':generateContent',
    );
  });
  modelInformation.deprecatedImageModelNames.forEach((modelName) => {
    googleLlmBaseApiUrls.push(
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':predict',
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':predictLongRunning',
    );
  });

  const pendingFetchResolvers = {};
  let nextPromiseId = 0;

  function handleStringInput(input, optionsArgument) {
    const actualUrl = input;
    const fetchCallArgs = [actualUrl, optionsArgument];
    const effectiveOptions = optionsArgument || {};
    const bodyForApiKeyCheck = effectiveOptions.body;
    const bodyForPostMessage = effectiveOptions.body;
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  function handleRequestInput(input, optionsArgument) {
    const actualUrl = input.url;
    const fetchCallArgs = [input, optionsArgument];
    const effectiveOptions = { method: input.method, headers: new Headers(input.headers) };
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (optionsArgument) {
      if (optionsArgument.method) effectiveOptions.method = optionsArgument.method;
      if (optionsArgument.headers) effectiveOptions.headers = new Headers(optionsArgument.headers);
      if ('body' in optionsArgument) {
        bodyForApiKeyCheck = optionsArgument.body;
        bodyForPostMessage = optionsArgument.body;
      } else {
        bodyForApiKeyCheck = undefined;
        bodyForPostMessage = input.body;
      }
    } else {
      bodyForApiKeyCheck = undefined;
      bodyForPostMessage = input.body;
    }
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  window.fetch = function(input, optionsArgument) {
    let actualUrl;
    let fetchCallArgs;
    let effectiveOptions = {};
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (typeof input === 'string') {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleStringInput(input, optionsArgument));
    } else if (input instanceof Request) {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleRequestInput(input, optionsArgument));
    } else {
      return originalFetch.apply(window, [input, optionsArgument]);
    }

    effectiveOptions.method = effectiveOptions.method || 'GET';
    if (!effectiveOptions.headers) {
      effectiveOptions.headers = new Headers();
    }


    if (typeof actualUrl === 'string' && googleLlmBaseApiUrls.some((url) => actualUrl.startsWith(url))) {
      let apiKeyIsNull = true;

      const regex = new RegExp("models/([^:]+)");
      const modelNameMatch = actualUrl.match(regex);
      const modelName = modelNameMatch ? modelNameMatch[1] : 'unspecified';


      try {
        const urlObject = new URL(actualUrl);  // Use URL object for robust parsing
        const apiKeyParam = urlObject.searchParams.get('key');
        if (apiKeyParam) {
          apiKeyIsNull = false;
        }
      } catch (e) {
        // Continue checks even if URL parsing fails
      }

      if (apiKeyIsNull && effectiveOptions.headers) {
        const h = new Headers(effectiveOptions.headers);
        const apiKeyHeaderValue = h.get('X-API-Key') || h.get('x-api-key');
        if (apiKeyHeaderValue) {
          apiKeyIsNull = false;
          return originalFetch.apply(window, fetchCallArgs);
        }
      }

      if (apiKeyIsNull && effectiveOptions.method && ['POST', 'PUT', 'PATCH'].includes(effectiveOptions.method.toUpperCase()) && typeof bodyForApiKeyCheck === 'string') {
        try {
          const bodyData = JSON.parse(bodyForApiKeyCheck);
          if (bodyData && bodyData.apiKey) {
            apiKeyIsNull = false;
            return originalFetch.apply(window, fetchCallArgs);
          }
        } catch (e) {
          // Ignore JSON parsing errors
        }
      }

      if(apiKeyIsNull) {
        const promiseId = nextPromiseId++;
        const promise = new Promise((resolve) => {
          pendingFetchResolvers[promiseId] = (resolvedResponse) => {
            delete pendingFetchResolvers[promiseId];
            resolve(resolvedResponse);
          };
        });

        let serializedBodyForPostMessage;
        if (typeof bodyForPostMessage === 'string' || bodyForPostMessage == null) {
            serializedBodyForPostMessage = bodyForPostMessage;
        } else if (bodyForPostMessage instanceof ReadableStream) {
            serializedBodyForPostMessage = null;
        } else {
            try {
                serializedBodyForPostMessage = JSON.stringify(bodyForPostMessage);
            } catch (e) {
                serializedBodyForPostMessage = null;
            }
        }

        const messageOptions = {
            method: effectiveOptions.method,
            headers: Object.fromEntries(new Headers(effectiveOptions.headers).entries()),
            body: serializedBodyForPostMessage
        };

        window.parent.postMessage({
          type: 'requestFetch',
          url: actualUrl,
          modelName: modelName,
          options: messageOptions,
          promiseId: promiseId,
        }, '*');

        return promise;
      }
      return originalFetch.apply(window, fetchCallArgs);
    }
    return originalFetch.apply(window, fetchCallArgs);
  };

  window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'resolveFetch') {
      const { promiseId, response } = event.data;
      if (pendingFetchResolvers[promiseId]) {
        try {
          const reconstructedResponse = new Response(response.body, {
            status: response.status,
            statusText: response.statusText,
            headers: new Headers(response.headers),
          });
          pendingFetchResolvers[promiseId](reconstructedResponse);
        } catch (error) {
          pendingFetchResolvers[promiseId](new Response(null, { status: 500, statusText: "Interceptor Response Reconstruction Error" }));
        }
      }
    }
  });

}))({"textModelName":"gemini-2.5-flash-preview-09-2025","imageModelName":"imagen-4.0-generate-001","imageEditModelName":"gemini-2.5-flash-image-preview","videoModelName":"veo-2.0-generate-001","ttsModelName":"gemini-2.5-flash-preview-tts","deprecatedTextModelNames":["gemini-2.0-flash","gemini-2.5-flash-preview-04-17","gemini-2.5-flash-preview-05-20"],"deprecatedImageModelNames":["imagen-3.0-generate-001","imagen-3.0-generate-002"]})</script><script>(function() {
  const originalConsoleLog = console.log;
  const originalConsoleError = console.error;

    /**
   * Normalizes an error event or a promise rejection reason into a structured error object.
   * @param {*} errorEventOrReason The error object or reason.
   * @return {object} Structured error data { message, name, stack }.
   */
  function getErrorObject(errorEventOrReason) {
    if (errorEventOrReason instanceof Error) {
      return {
        message: errorEventOrReason.message,
        name: errorEventOrReason.name,
        stack: errorEventOrReason.stack,
      };
    }
    // Fallback for non-Error objects.
    try {
      return {
        message: JSON.stringify(errorEventOrReason),
        name: 'UnknownErrorType',
        stack: null,
      };
    } catch (e) {
      return {
        message: String(errorEventOrReason),
        name: 'UnknownErrorTypeNonStringifiable',
        stack: null,
      };
    }
  }

  /**
   * Converts an array of arguments (from log/error) into a single string.
   * Handles Error objects specially to include their message and stack.
   * @param {Array<*>} args - Arguments passed to console methods.
   * @return {string} A string representation of the arguments.
   */
  function stringifyArgs(args) {
    return args
      .map((arg) => {
        if (arg instanceof Error) {
          const {message, stack} = arg;
          return `Error: ${message}${stack ? ('\nStack: ' + stack) : ''}`;
        }
        if (typeof arg === 'object' && arg !== null) {
          try {
            return JSON.stringify(arg);
          } catch (error) {
            return '[Circular Object]';
          }
        } else {
          return String(arg);
        }
      })
      .join(' ');
  }

  console.log = function(...args) {
    const logString = stringifyArgs(args);
    window.parent.postMessage({ type: 'log', message: logString }, '*');
    originalConsoleLog.apply(console, args);
  };

  console.error = function(...args) {
    let errorData;
    if (args.length > 0 && args[0] instanceof Error) {
      const err = args[0];
      // If the first arg is an Error, capture its details.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        ...getErrorObject(err),
        rawArgsString: stringifyArgs(args.slice(1)),
        timestamp: new Date().toISOString(),
      };
    } else {
      // If not an Error object, treat all args as a general error message.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        message: stringifyArgs(args),
        name: 'ConsoleLoggedError',
        stack: null,
        timestamp: new Date().toISOString(),
      };
    }
    window.parent.postMessage(errorData, '*');
    originalConsoleError.apply(console, args);
  };

  // Listen for global unhandled synchronous errors.
  window.addEventListener('error', function(event) {
    const errorDetails = event.error ? getErrorObject(event.error) : {
      message: event.message,
      name: 'GlobalError',
      stack: null,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
    };

    window.parent.postMessage({
      type: 'error',
      source: 'global',
      ...errorDetails,
      message: errorDetails.message || event.message,
      timestamp: new Date().toISOString(),
    }, '*');
  });

  // Listen for unhandled promise rejections (asynchronous errors).
  window.addEventListener('unhandledrejection', function(event) {
    const errorDetails = getErrorObject(event.reason);

    window.parent.postMessage({
      type: 'error',
      source: 'unhandledrejection',
      ...errorDetails,
      message: errorDetails.message || 'Unhandled Promise Rejection',
      timestamp: new Date().toISOString(),
    }, '*');
  });

})();</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق تسجيل وتقييم الطلاب</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- تحميل مكتبات تصدير PDF -->
    <!-- jsPDF: لإنشاء ملف PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>
    <!-- html2canvas: لتحويل جزء من HTML إلى صورة (Canvas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&amp;display=swap" rel="stylesheet">
    
    <style>
        /* إعدادات الخطوط والاتجاه */
        body {
            font-family: 'Tajawal', sans-serif;
        }
        /* إخفاء الأسهم في حقول الأرقام */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* تصميم مخصص لشريط التمرير */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
        /* كلاس لإخفاء الأزرار المخصصة للطباعة */
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border-width:0}.fixed{position:fixed}.inset-0{inset:0px}.z-40{z-index:40}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-12{margin-bottom:3rem}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mt-12{margin-top:3rem}.mt-2{margin-top:0.5rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.block{display:block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-16{height:4rem}.h-\[90vh\]{height:90vh}.max-h-20{max-height:5rem}.min-h-screen{min-height:100vh}.w-16{width:4rem}.w-full{width:100%}.max-w-3xl{max-width:48rem}.max-w-6xl{max-width:72rem}.max-w-lg{max-width:32rem}.max-w-sm{max-width:24rem}.flex-shrink-0{flex-shrink:0}.flex-grow{flex-grow:1}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.gap-6{gap:1.5rem}.gap-8{gap:2rem}.gap-3{gap:0.75rem}.gap-4{gap:1rem}.space-x-2 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(0.5rem * var(--tw-space-x-reverse));margin-left:calc(0.5rem * calc(1 - var(--tw-space-x-reverse)))}.space-x-4 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1rem * var(--tw-space-x-reverse));margin-left:calc(1rem * calc(1 - var(--tw-space-x-reverse)))}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.space-y-6 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem * var(--tw-space-y-reverse))}.space-y-8 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(2rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(2rem * var(--tw-space-y-reverse))}.space-x-reverse > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:1}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}.rounded-t-xl{border-top-left-radius:0.75rem;border-top-right-radius:0.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-b-2{border-bottom-width:2px}.border-t-2{border-top-width:2px}.border-dashed{border-style:dashed}.border-blue-500{--tw-border-opacity:1;border-color:rgb(59 130 246 / var(--tw-border-opacity, 1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235 / var(--tw-border-opacity, 1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.border-gray-500{--tw-border-opacity:1;border-color:rgb(107 114 128 / var(--tw-border-opacity, 1))}.border-green-500{--tw-border-opacity:1;border-color:rgb(34 197 94 / var(--tw-border-opacity, 1))}.border-indigo-500{--tw-border-opacity:1;border-color:rgb(99 102 241 / var(--tw-border-opacity, 1))}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity, 1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246 / var(--tw-bg-opacity, 1))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgb(229 231 235 / var(--tw-bg-opacity, 1))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-white\/80{background-color:rgb(255 255 255 / 0.8)}.bg-yellow-100{--tw-bg-opacity:1;background-color:rgb(254 249 195 / var(--tw-bg-opacity, 1))}.bg-opacity-50{--tw-bg-opacity:0.5}.bg-opacity-70{--tw-bg-opacity:0.7}.bg-gradient-to-br{background-image:linear-gradient(to bottom right, var(--tw-gradient-stops))}.bg-gradient-to-r{background-image:linear-gradient(to right, var(--tw-gradient-stops))}.from-gray-100{--tw-gradient-from:#f3f4f6 var(--tw-gradient-from-position);--tw-gradient-to:rgb(243 244 246 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-blue-500{--tw-gradient-from:#3b82f6 var(--tw-gradient-from-position);--tw-gradient-to:rgb(59 130 246 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-green-500{--tw-gradient-from:#22c55e var(--tw-gradient-from-position);--tw-gradient-to:rgb(34 197 94 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-indigo-500{--tw-gradient-from:#6366f1 var(--tw-gradient-from-position);--tw-gradient-to:rgb(99 102 241 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-purple-500{--tw-gradient-from:#a855f7 var(--tw-gradient-from-position);--tw-gradient-to:rgb(168 85 247 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-red-500{--tw-gradient-from:#ef4444 var(--tw-gradient-from-position);--tw-gradient-to:rgb(239 68 68 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.to-blue-100{--tw-gradient-to:#dbeafe var(--tw-gradient-to-position)}.to-indigo-600{--tw-gradient-to:#4f46e5 var(--tw-gradient-to-position)}.to-orange-500{--tw-gradient-to:#f97316 var(--tw-gradient-to-position)}.to-pink-500{--tw-gradient-to:#ec4899 var(--tw-gradient-to-position)}.to-purple-600{--tw-gradient-to:#9333ea var(--tw-gradient-to-position)}.to-teal-600{--tw-gradient-to:#0d9488 var(--tw-gradient-to-position)}.p-10{padding:2.5rem}.p-3{padding:0.75rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.px-4{padding-left:1rem;padding-right:1rem}.px-5{padding-left:1.25rem;padding-right:1.25rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.px-8{padding-left:2rem;padding-right:2rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.pb-3{padding-bottom:0.75rem}.pb-4{padding-bottom:1rem}.pt-4{padding-top:1rem}.pt-6{padding-top:1.5rem}.pt-8{padding-top:2rem}.text-center{text-align:center}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246 / var(--tw-text-opacity, 1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity, 1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity, 1))}.text-green-500{--tw-text-opacity:1;color:rgb(34 197 94 / var(--tw-text-opacity, 1))}.text-indigo-600{--tw-text-opacity:1;color:rgb(79 70 229 / var(--tw-text-opacity, 1))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-yellow-500{--tw-text-opacity:1;color:rgb(234 179 8 / var(--tw-text-opacity, 1))}.text-yellow-800{--tw-text-opacity:1;color:rgb(133 77 14 / var(--tw-text-opacity, 1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216 / var(--tw-text-opacity, 1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-md{--tw-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color), 0 2px 4px -2px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.backdrop-blur-sm{--tw-backdrop-blur:blur(4px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition{transition-property:color, background-color, border-color, fill, stroke, opacity, box-shadow, transform, filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-300{transition-duration:300ms}.duration-500{transition-duration:500ms}.ease-in-out{transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1)}.file\:mr-4::file-selector-button{margin-right:1rem}.file\:rounded-lg::file-selector-button{border-radius:0.5rem}.file\:border-0::file-selector-button{border-width:0px}.file\:bg-blue-50::file-selector-button{--tw-bg-opacity:1;background-color:rgb(239 246 255 / var(--tw-bg-opacity, 1))}.file\:px-4::file-selector-button{padding-left:1rem;padding-right:1rem}.file\:py-2::file-selector-button{padding-top:0.5rem;padding-bottom:0.5rem}.file\:text-sm::file-selector-button{font-size:0.875rem;line-height:1.25rem}.file\:font-semibold::file-selector-button{font-weight:600}.file\:text-blue-700::file-selector-button{--tw-text-opacity:1;color:rgb(29 78 216 / var(--tw-text-opacity, 1))}.hover\:-translate-y-0\.5:hover{--tw-translate-y:-0.125rem;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:-translate-y-1:hover{--tw-translate-y:-0.25rem;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:scale-105:hover{--tw-scale-x:1.05;--tw-scale-y:1.05;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-300:hover{--tw-bg-opacity:1;background-color:rgb(209 213 219 / var(--tw-bg-opacity, 1))}.hover\:bg-white:hover{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.hover\:from-blue-600:hover{--tw-gradient-from:#2563eb var(--tw-gradient-from-position);--tw-gradient-to:rgb(37 99 235 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.hover\:from-green-600:hover{--tw-gradient-from:#16a34a var(--tw-gradient-from-position);--tw-gradient-to:rgb(22 163 74 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.hover\:from-indigo-600:hover{--tw-gradient-from:#4f46e5 var(--tw-gradient-from-position);--tw-gradient-to:rgb(79 70 229 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.hover\:from-purple-600:hover{--tw-gradient-from:#9333ea var(--tw-gradient-from-position);--tw-gradient-to:rgb(147 51 234 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.hover\:from-red-600:hover{--tw-gradient-from:#dc2626 var(--tw-gradient-from-position);--tw-gradient-to:rgb(220 38 38 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.hover\:to-indigo-700:hover{--tw-gradient-to:#4338ca var(--tw-gradient-to-position)}.hover\:to-orange-600:hover{--tw-gradient-to:#ea580c var(--tw-gradient-to-position)}.hover\:to-pink-600:hover{--tw-gradient-to:#db2777 var(--tw-gradient-to-position)}.hover\:to-purple-700:hover{--tw-gradient-to:#7e22ce var(--tw-gradient-to-position)}.hover\:to-teal-700:hover{--tw-gradient-to:#0f766e var(--tw-gradient-to-position)}.hover\:text-red-800:hover{--tw-text-opacity:1;color:rgb(153 27 27 / var(--tw-text-opacity, 1))}.hover\:shadow-lg:hover{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.hover\:file\:bg-blue-100::file-selector-button:hover{--tw-bg-opacity:1;background-color:rgb(219 234 254 / var(--tw-bg-opacity, 1))}.focus\:border-blue-500:focus{--tw-border-opacity:1;border-color:rgb(59 130 246 / var(--tw-border-opacity, 1))}.focus\:border-indigo-500:focus{--tw-border-opacity:1;border-color:rgb(99 102 241 / var(--tw-border-opacity, 1))}.focus\:ring-blue-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(59 130 246 / var(--tw-ring-opacity, 1))}.focus\:ring-indigo-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(99 102 241 / var(--tw-ring-opacity, 1))}@media (min-width: 768px){.md\:w-1\/2{width:50%}.md\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.md\:flex-row{flex-direction:row}.md\:p-12{padding:3rem}.md\:p-6{padding:1.5rem}.md\:p-8{padding:2rem}.md\:text-3xl{font-size:1.875rem;line-height:2.25rem}}</style><style type="text/css"><br>            .score-btn {<br>                padding: 0.75rem 1rem;<br>                border-radius: 0.5rem;<br>                font-weight: 600;<br>                transition: all 0.2s ease-in-out;<br>                background-color: #e5e7eb; /* bg-gray-200 */<br>                color: #374151; /* text-gray-700 */<br>                border: 1px solid #d1d5db; /* border-gray-300 */<br>            }<br>            .score-btn:hover {<br>                background-color: #d1d5db; /* hover:bg-gray-300 */<br>            }<br>            .score-btn.selected {<br>                background-color: #3b82f6; /* bg-blue-600 */<br>                color: white;<br>                box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);<br>                border-color: #2563eb;<br>            }<br>        </style></head>
<body class="bg-gradient-to-br from-gray-100 to-blue-100 min-h-screen">

    <!-- حاوي التطبيق الرئيسي -->
    <div id="app" class="max-w-6xl mx-auto p-4 md:p-8">

        <!-- الهيدر وشعار التطبيق -->
        <header class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg border border-gray-200 p-4 md:p-6 mb-8 flex justify-between items-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
                <span class="text-blue-600">نظام</span> تقييم الطلاب
            </h1>
            <button id="settingsButton" onclick="showPage('settingsPage')" class="no-print bg-gray-200 text-gray-700 hover:bg-gray-300 py-2 px-4 rounded-lg font-semibold shadow-md transition duration-300 ease-in-out transform hover:-translate-y-0.5">
                الإعدادات
            </button>
        </header>

        <!-- المحتوى الديناميكي (الصفحات) -->
        <main>
            <!-- الصفحة الرئيسية (القائمة) -->
            <div id="mainMenu" class="text-center space-y-8 p-10 hidden">
                <h2 class="text-4xl font-bold text-gray-700 mb-12">أهلاً بك</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- بطاقة تسجيل طالب -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200 p-8 transform transition duration-500 hover:scale-105">
                        <svg class="w-16 h-16 text-blue-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        <h3 class="text-2xl font-semibold text-gray-800 mb-6">تسجيل طالب جديد</h3>
                        <p class="text-gray-600 mb-6">إضافة بيانات طالب جديد إلى النظام للمشاركة في التقييم.</p>
                        <button onclick="showPage('registrationPage')" class="w-full py-3 px-6 rounded-lg font-semibold shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 bg-gradient-to-r from-blue-500 to-indigo-600 text-white hover:from-blue-600 hover:to-indigo-700">
                            ابدأ التسجيل
                        </button>
                    </div>
                    <!-- بطاقة تقييم طالب -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200 p-8 transform transition duration-500 hover:scale-105">
                        <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h3 class="text-2xl font-semibold text-gray-800 mb-6">تقييم الطلاب</h3>
                        <p class="text-gray-600 mb-6">الدخول إلى لوحة التقييم وتعبئة النماذج ومراجعة النتائج.</p>
                        <button onclick="showPage('passwordPage')" class="w-full py-3 px-6 rounded-lg font-semibold shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 bg-gradient-to-r from-green-500 to-teal-600 text-white hover:from-green-600 hover:to-teal-700">
                            الدخول للتقييم
                        </button>
                    </div>
                </div>
            </div>

            <!-- صفحة تسجيل طالب -->
            <div id="registrationPage" class="hidden bg-white/80 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200 p-8 md:p-12">
                <h2 class="text-3xl font-bold text-gray-800 mb-8 border-b-2 border-blue-500 pb-4">تسجيل طالب جديد</h2>
                <form id="registrationForm" class="space-y-6">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="studentName" class="block text-sm font-medium text-gray-700 mb-2">اسم الطالب كاملاً</label>
                            <input type="text" id="studentName" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition" required="">
                        </div>
                        <div>
                            <label for="broadcastDate" class="block text-sm font-medium text-gray-700 mb-2">تاريخ الإذاعة</label>
                            <input type="date" id="broadcastDate" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition" required="">
                        </div>
                    </div>
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <label for="studentGrade" class="block text-sm font-medium text-gray-700 mb-2">الصف الدراسي</label>
                            <select id="studentGrade" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition">
                                <option value="الأول">الأول</option>
                                <option value="الثاني">الثاني</option>
                                <option value="الثالث">الثالث</option>
                                <option value="الرابع">الرابع</option>
                                <option value="الخامس">الخامس</option>
                                <option value="السادس">السادس</option>
                            </select>
                        </div>
                        <div>
                            <label for="studentSection" class="block text-sm font-medium text-gray-700 mb-2">رقم الشعبة/الفصل</label>
                            <select id="studentSection" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                        </div>
                        <div>
                            <label for="studentDepartment" class="block text-sm font-medium text-gray-700 mb-2">القسم</label>
                            <select id="studentDepartment" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition">
                                <option value="عام">عام</option>
                                <option value="تحفيظ">تحفيظ</option>
                                <option value="دبلومة">دبلومة</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="studentGroup" class="block text-sm font-medium text-gray-700 mb-2">مجموعة المربي المخلص</label>
                        <input type="text" id="studentGroup" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition" required="">
                    </div>
                    
                    <div class="flex justify-end space-x-4 space-x-reverse pt-6">
                        <button type="button" onclick="showPage('mainMenu')" class="py-3 px-6 rounded-lg font-semibold shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 bg-gray-200 text-gray-700 hover:bg-gray-300">
                            إلغاء
                        </button>
                        <button type="submit" class="py-3 px-6 rounded-lg font-semibold shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 bg-gradient-to-r from-blue-500 to-indigo-600 text-white hover:from-blue-600 hover:to-indigo-700">
                            سجل الطالب الآن
                        </button>
                    </div>
                </form>
            </div>

            <!-- صفحة كلمة المرور -->
            <div id="passwordPage" class="bg-white/80 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200 p-8 md:p-12 max-w-lg mx-auto text-center hidden">
                <svg class="w-16 h-16 text-yellow-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                <h2 class="text-3xl font-bold text-gray-800 mb-6">الوصول مقيد</h2>
                <p class="text-gray-600 mb-8">الرجاء إدخال كلمة المرور للوصول إلى لوحة التقييم.</p>
                <form id="passwordForm" class="space-y-6">
                    <div>
                        <label for="passwordInput" class="sr-only">كلمة المرور</label>
                        <input type="password" id="passwordInput" class="w-full p-4 text-lg text-center rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="******" required="">
                    </div>
                    <div class="flex justify-center space-x-4 space-x-reverse pt-4">
                        <button type="button" onclick="showPage('mainMenu')" class="py-3 px-6 rounded-lg font-semibold shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 bg-gray-200 text-gray-700 hover:bg-gray-300">
                            رجوع
                        </button>
                        <button type="submit" class="py-3 px-6 rounded-lg font-semibold shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 bg-gradient-to-r from-green-500 to-teal-600 text-white hover:from-green-600 hover:to-teal-700">
                            دخول
                        </button>
                    </div>
                </form>
            </div>

            <!-- صفحة قائمة التقييم -->
            <div id="evaluationList" class="bg-white/80 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200 p-8 md:p-12 hidden">
                <div class="flex justify-between items-center mb-8 border-b-2 border-green-500 pb-4">
                    <h2 class="text-3xl font-bold text-gray-800">قائمة الطلاب للتقييم</h2>
                    <button type="button" onclick="showPage('mainMenu')" class="py-2 px-4 rounded-lg font-semibold shadow-md transition duration-300 ease-in-out bg-gray-200 text-gray-700 hover:bg-gray-300">
                        العودة للقائمة
                    </button>
                </div>

                <div class="mb-6 text-center">
                    <button id="exportAllStudents" class="py-3 px-8 rounded-lg font-semibold shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:from-purple-600 hover:to-pink-600">
                        تصدير نتائج كل الطلاب (PDF)
                    </button>
                </div>

                <div id="studentListContainer" class="space-y-4"><div class="p-4 bg-gray-50 rounded-lg shadow-md border border-gray-200 flex flex-col md:flex-row justify-between items-center gap-4 transition duration-300 hover:shadow-lg hover:bg-white">
                                    <div class="flex-grow">
                                        <h4 class="text-xl font-semibold text-blue-700">عبدالله</h4>
                                        <p class="text-sm text-gray-600">
                                            الأول / 1 (عام) | مجموعة: م
                                        </p>
                                        <p class="text-sm text-gray-500">تاريخ الإذاعة: 2025-11-08</p>
                                    </div>
                                    <div class="flex-shrink-0 flex items-center gap-3">
                                        <span class="text-lg font-bold text-gray-400">
                                            لم يتم التقييم
                                        </span>
                                        <button classdata-student-id="eDrEB9Mg1UC6K5txIBy6" class="export-student-pdf py-2 px-4 rounded-lg font-semibold shadow-md transition duration-300 ease-in-out bg-gradient-to-r from-green-500 to-teal-600 text-white hover:from-green-600 hover:to-teal-700">
                                            تصدير (PDF)
                                        </button>
                                        <button data-student-id="eDrEB9Mg1UC6K5txIBy6" class="rate-student py-2 px-6 rounded-lg font-semibold shadow-md transition duration-300 ease-in-out bg-blue-600 text-white hover:bg-blue-700">
                                            تقييم
                                        </button>
                                    </div>
                                </div></div>
            </div>

            <!-- صفحة نموذج التقييم -->
            <div id="ratingPage" class="hidden bg-white/80 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200 p-8 md:p-12">
                <div class="flex justify-between items-center mb-8 border-b-2 border-indigo-500 pb-4">
                    <h2 class="text-3xl font-bold text-gray-800">تقييم الطالب: <span id="ratingStudentName" class="text-indigo-600"></span></h2>
                    <button type="button" onclick="showPage('evaluationList')" class="py-2 px-4 rounded-lg font-semibold shadow-md transition duration-300 ease-in-out bg-gray-200 text-gray-700 hover:bg-gray-300">
                        العودة للقائمة
                    </button>
                </div>

                <form id="ratingForm" class="space-y-8">
                    <!-- اختيار المقيّم -->
                    <div>
                        <label for="evaluatorName" class="block text-lg font-medium text-gray-700 mb-2">1. اختر اسم المقيّم:</label>
                        <select id="evaluatorName" class="w-full md:w-1/2 p-3 rounded-lg border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option value="">-- اختر --</option>
                            <option value="محمد مفرح العتيبي">محمد مفرح العتيبي</option>
                            <option value="فهد الطوياوي">فهد الطوياوي</option>
                            <option value="منتصر محمد">منتصر محمد</option>
                        </select>
                        <p id="loadingRatingMessage" class="text-sm text-blue-600 mt-2 hidden">جاري تحميل التقييم السابق...</p>
                    </div>

                    <!-- معايير التقييم -->
                    <div id="criteriaSection" class="space-y-6 hidden">
                        <h3 class="text-lg font-medium text-gray-700">2. ابدأ التقييم (5 ممتاز - 1 ضعيف):</h3>
                        
                        <!-- الإعداد الجيد -->
                        <div class="criteria-group p-4 rounded-lg border border-gray-200 bg-gray-50">
                            <label class="block text-md font-semibold text-gray-800 mb-3">أ. الإعداد الجيد</label>
                            <div class="flex flex-wrap gap-2 score-buttons" data-criteria="preparation">
                                <button type="button" data-score="5" class="score-btn">ممتاز (5)</button>
                                <button type="button" data-score="4" class="score-btn">جيد جداً (4)</button>
                                <button type="button" data-score="3" class="score-btn">جيد (3)</button>
                                <button type="button" data-score="2" class="score-btn">مقبول (2)</button>
                                <button type="button" data-score="1" class="score-btn">ضعيف (1)</button>
                            </div>
                            <input type="hidden" id="preparationScore" data-criteria-name="preparation" required="">
                        </div>
                        
                        <!-- التنوع -->
                        <div class="criteria-group p-4 rounded-lg border border-gray-200 bg-gray-50">
                            <label class="block text-md font-semibold text-gray-800 mb-3">ب. التنوع</label>
                            <div class="flex flex-wrap gap-2 score-buttons" data-criteria="diversity">
                                <button type="button" data-score="5" class="score-btn">ممتاز (5)</button>
                                <button type="button" data-score="4" class="score-btn">جيد جداً (4)</button>
                                <button type="button" data-score="3" class="score-btn">جيد (3)</button>
                                <button type="button" data-score="2" class="score-btn">مقبول (2)</button>
                                <button type="button" data-score="1" class="score-btn">ضعيف (1)</button>
                            </div>
                            <input type="hidden" id="diversityScore" data-criteria-name="diversity" required="">
                        </div>
                        
                        <!-- وضوح الرسالة -->
                        <div class="criteria-group p-4 rounded-lg border border-gray-200 bg-gray-50">
                            <label class="block text-md font-semibold text-gray-800 mb-3">ج. وضوح الرسالة الموجهة</label>
                            <div class="flex flex-wrap gap-2 score-buttons" data-criteria="clarity">
                                <button type="button" data-score="5" class="score-btn">ممتاز (5)</button>
                                <button type="button" data-score="4" class="score-btn">جيد جداً (4)</button>
                                <button type="button" data-score="3" class="score-btn">جيد (3)</button>
                                <button type="button" data-score="2" class="score-btn">مقبول (2)</button>
                                <button type="button" data-score="1" class="score-btn">ضعيف (1)</button>
                            </div>
                            <input type="hidden" id="clarityScore" data-criteria-name="clarity" required="">
                        </div>
                        
                        <!-- جودة الإلقاء -->
                        <div class="criteria-group p-4 rounded-lg border border-gray-200 bg-gray-50">
                            <label class="block text-md font-semibold text-gray-800 mb-3">د. جودة الإلقاء</label>
                            <div class="flex flex-wrap gap-2 score-buttons" data-criteria="delivery">
                                <button type="button" data-score="5" class="score-btn">ممتاز (5)</button>
                                <button type="button" data-score="4" class="score-btn">جيد جداً (4)</button>
                                <button type="button" data-score="3" class="score-btn">جيد (3)</button>
                                <button type="button" data-score="2" class="score-btn">مقبول (2)</button>
                                <button type="button" data-score="1" class="score-btn">ضعيف (1)</button>
                            </div>
                            <input type="hidden" id="deliveryScore" data-criteria-name="delivery" required="">
                        </div>
                    </div>
                    
                    <div id="ratingActions" class="flex justify-end space-x-4 space-x-reverse pt-6 hidden">
                        <button type="submit" class="py-3 px-8 rounded-lg font-semibold shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 bg-gradient-to-r from-indigo-500 to-purple-600 text-white hover:from-indigo-600 hover:to-purple-700">
                            حفظ التقييم
                        </button>
                    </div>
                </form>

                <!-- سجل التقييمات السابقة -->
                <div id="evaluationHistory" class="mt-12 hidden">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b-2 border-gray-300 pb-3">سجل التقييمات السابقة للطالب</h3>
                    <div id="historyTableContainer" class="overflow-x-auto">
                        <!-- الجدول سيُدرج هنا -->
                    </div>
                </div>
            </div>

            <!-- صفحة الإعدادات -->
            <div id="settingsPage" class="bg-white/80 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200 p-8 md:p-12">
                <div class="flex justify-between items-center mb-8 border-b-2 border-gray-500 pb-4">
                    <h2 class="text-3xl font-bold text-gray-800">الإعدادات</h2>
                    <button type="button" onclick="goBackFromSettings()" class="py-2 px-4 rounded-lg font-semibold shadow-md transition duration-300 ease-in-out bg-gray-200 text-gray-700 hover:bg-gray-300">
                        رجوع
                    </button>
                </div>
                
                <form id="settingsForm" class="space-y-8">
                    <h3 class="text-xl font-semibold text-gray-700">تخصيص قالب تقرير PDF</h3>
                    <div class="p-6 rounded-lg border border-gray-200 bg-gray-50 space-y-6">
                        <div>
                            <label for="reportTitle" class="block text-sm font-medium text-gray-700 mb-2">عنوان التقرير (مثال: تقرير تقييم الطالب)</label>
                            <input type="text" id="reportTitle" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                        <div>
                            <label for="reportFooter" class="block text-sm font-medium text-gray-700 mb-2">تذييل التقرير (مثال: لجنة التقييم)</label>
                            <input type="text" id="reportFooter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                        <div>
                            <label for="reportHeaderImage" class="block text-sm font-medium text-gray-700 mb-2">شعار رأس التقرير (اختياري)</label>
                            <input type="file" id="reportHeaderImage" accept="image/png, image/jpeg" class="w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-lg file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100
                            ">
                            <img id="imagePreview" src="" alt="معاينة الشعار" class="mt-4 max-h-20 hidden rounded-lg">
                            <button type="button" id="removeImageBtn" class="mt-2 text-sm text-red-600 hover:text-red-800 hidden">إزالة الصورة</button>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="py-3 px-6 rounded-lg font-semibold shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 bg-gradient-to-r from-blue-500 to-indigo-600 text-white hover:from-blue-600 hover:to-indigo-700">
                            حفظ الإعدادات
                        </button>
                    </div>
                </form>

                <!-- قسم تصدير التطبيق (يظهر فقط عند الدخول من صفحة التقييم) -->
                <div id="exportAppSection" class="mt-12 pt-8 border-t-2 border-dashed border-gray-300">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">أدوات متقدمة</h3>
                    <p class="text-gray-600 mb-4">
                        يمكنك تصدير نسخة كاملة من هذا التطبيق كملف HTML واحد.
                        <strong class="block text-yellow-800 bg-yellow-100 p-3 rounded-lg mt-2">ملاحظة هامة:</strong> هذا الخيار سيقوم بتصدير واجهة التطبيق والشيفرة البرمجية الخاصة به. بما أن التطبيق يعتمد على قاعدة بيانات سحابية (Firestore) للعمل، فإن الملف المُصدّر سيظل بحاجة للاتصال بالإنترنت للوصول إلى خوادم Firebase وحفظ البيانات. لا يمكن جعل التطبيق "محلياً بالكامل" دون إعادة كتابته لاستخدام التخزين المحلي بدلاً من Firestore.
                    </p>
                    <button id="exportAppButton" class="py-3 px-8 rounded-lg font-semibold shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 bg-gradient-to-r from-red-500 to-orange-500 text-white hover:from-red-600 hover:to-orange-600">
                        تصدير التطبيق بالكامل (.html)
                    </button>
                </div>
            </div>

        </main>

    </div>

    <!-- نافذة الرسائل المنبثقة (Modal) -->
    <div id="messageModal" class="no-print hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full">
            <div id="messageModalHeader" class="p-5 rounded-t-xl text-white">
                <h3 id="messageModalTitle" class="text-2xl font-bold text-center"></h3>
            </div>
            <div class="p-6 text-center">
                <p id="messageModalBody" class="text-gray-700 text-lg"></p>
                <button onclick="closeModal('messageModal')" class="mt-6 bg-blue-600 text-white py-2 px-8 rounded-lg font-semibold shadow-lg hover:bg-blue-700 transition duration-300">
                    إغلاق
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة معاينة وتصدير PDF -->
    <div id="pdfPreviewModal" class="no-print hidden fixed inset-0 z-40 bg-black bg-opacity-70 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full h-[90vh] flex flex-col">
            <!-- شريط الأدوات -->
            <div class="flex-shrink-0 p-4 bg-gray-100 rounded-t-xl flex justify-between items-center border-b">
                <h3 class="text-xl font-bold text-gray-800">معاينة التصدير</h3>
                <div class="space-x-2 space-x-reverse">
                    <button id="pdfConfirmButton" class="py-2 px-5 rounded-lg font-semibold shadow-lg transition duration-300 ease-in-out bg-gradient-to-r from-green-500 to-teal-600 text-white hover:from-green-600 hover:to-teal-700">
                        تأكيد التصدير (PDF)
                    </button>
                    <button onclick="closeModal('pdfPreviewModal')" class="py-2 px-5 rounded-lg font-semibold shadow-md bg-gray-200 text-gray-700 hover:bg-gray-300 transition">
                        إلغاء
                    </button>
                </div>
            </div>
            <!-- منطقة المحتوى القابل للتمرير -->
            <div class="flex-grow p-6 overflow-y-auto">
                <!-- هذا العنصر هو الذي سيتم تحويله إلى PDF -->
                <div id="pdf-content" class="bg-white p-8">
                    <!-- سيتم حقن محتوى التقرير هنا -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- تحميل Firebase SDKs (نهاية الـ body) -->
    <script type="module">
        // استيراد وظائف Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- إعدادات Firebase والاتصال ---

        // (يتم توفيرها من بيئة التشغيل)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, auth, db, userId;
        let studentsRef, ratingsRef, settingsRef;
        let currentStudentId = null;
        let currentRatingDocId = null;
        let previousPage = 'mainMenu'; // لتتبع الصفحة السابقة للإعدادات
        let appSettings = { // إعدادات افتراضية
            reportTitle: "تقرير تقييم الطالب",
            reportFooter: "لجنة التقييم",
            headerImageBase64: null
        };

        // متغيرات أزرار اختيار الدرجات (لإدارة الحالة)
        const scoreButtonsConfig = {
            preparation: null,
            diversity: null,
            clarity: null,
            delivery: null
        };

        // --- تهيئة التطبيق ---

        async function initializeMain() {
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing!");
                showMessage("خطأ فادح", "لم يتم العثور على إعدادات الاتصال بقاعدة البيانات.", "error");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // لإظهار سجلات Firebase

                // مراقبة حالة المصادقة
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User is authenticated:", userId);
                        
                        // تعريف مسارات قاعدة البيانات الخاصة بالمستخدم
                        studentsRef = collection(db, `artifacts/${appId}/users/${userId}/students`);
                        ratingsRef = collection(db, `artifacts/${appId}/users/${userId}/ratings`);
                        settingsRef = doc(db, `artifacts/${appId}/users/${userId}/settings/mainSettings`);
                        
                        // تحميل الإعدادات المخزنة
                        await loadSettings();

                    } else {
                        console.log("User not authenticated, trying sign-in...");
                        // محاولة تسجيل الدخول
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showMessage("خطأ في الاتصال", `حدث خطأ أثناء الاتصال بقاعدة البيانات: ${error.message}`, "error");
            }
        }

        // --- إدارة الواجهة والتنقل (SPA) ---

        window.showPage = (pageId) => {
            // تتبع الصفحة السابقة للرجوع من الإعدادات
            const currentPage = document.querySelector('main > div:not(.hidden)').id;
            if (currentPage !== 'settingsPage') {
                previousPage = currentPage;
            }

            // إخفاء جميع الصفحات
            document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
            
            // إظهار الصفحة المطلوبة
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.remove('hidden');
                
                // تحميل البيانات عند عرض الصفحات المعنية
                if (pageId === 'evaluationList') {
                    loadEvaluationList();
                }
                if (pageId === 'settingsPage') {
                    // عرض/إخفاء زر تصدير التطبيق
                    const exportSection = document.getElementById('exportAppSection');
                    exportSection.classList.toggle('hidden', previousPage !== 'evaluationList');
                    // ملء نموذج الإعدادات بالبيانات الحالية
                    fillSettingsForm();
                }
            }
        }

        window.goBackFromSettings = () => {
            showPage(previousPage || 'mainMenu');
        }

        window.closeModal = (modalId) => {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showMessage(title, body, type = 'success') {
            const modal = document.getElementById('messageModal');
            const header = document.getElementById('messageModalHeader');
            const titleEl = document.getElementById('messageModalTitle');
            const bodyEl = document.getElementById('messageModalBody');

            titleEl.textContent = title;
            bodyEl.textContent = body;

            header.classList.remove('bg-emerald-500', 'bg-red-500');
            if (type === 'success') {
                header.classList.add('bg-emerald-500');
            } else if (type === 'error') {
                header.classList.add('bg-red-500');
            }

            modal.classList.remove('hidden');
        }

        // --- وحدة تسجيل الطلاب ---

        const regForm = document.getElementById('registrationForm');
        regForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId || !studentsRef) {
                showMessage("خطأ", "لم يتم تهيئة قاعدة البيانات. حاول تحديث الصفحة.", "error");
                return;
            }

            const student = {
                name: document.getElementById('studentName').value,
                grade: document.getElementById('studentGrade').value,
                section: document.getElementById('studentSection').value,
                department: document.getElementById('studentDepartment').value,
                group: document.getElementById('studentGroup').value,
                broadcastDate: document.getElementById('broadcastDate').value,
                createdAt: Timestamp.now()
            };

            // التحقق من الحقول المطلوبة
            if (!student.name || !student.group || !student.broadcastDate) {
                showMessage("خطأ في الإدخال", "الرجاء ملء جميع الحقول المطلوبة (الاسم، المجموعة، التاريخ).", "error");
                return;
            }

            try {
                const docRef = await addDoc(studentsRef, student);
                console.log("Student registered with ID: ", docRef.id);
                showMessage("نجاح", "تم تسجيل الطالب بنجاح!", "success");
                regForm.reset();
                showPage('mainMenu');
            } catch (error) {
                console.error("Error adding student: ", error);
                showMessage("خطأ", `حدث خطأ أثناء حفظ الطالب: ${error.message}`, "error");
            }
        });

        // --- وحدة التقييم (كلمة المرور) ---

        const passForm = document.getElementById('passwordForm');
        passForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;
            if (password === '123') {
                showPage('evaluationList');
                passForm.reset();
            } else {
                showMessage("خطأ", "كلمة المرور غير صحيحة.", "error");
                document.getElementById('passwordInput').value = ''; // مسح كلمة المرور
            }
        });

        // --- وحدة التقييم (قائمة الطلاب) ---

        async function loadEvaluationList() {
            if (!userId || !studentsRef) return;

            const container = document.getElementById('studentListContainer');
            container.innerHTML = '<p class="text-gray-500 text-center">يتم الآن تحميل قائمة الطلاب...</p>';
            
            try {
                // استخدام onSnapshot للاستماع للتحديثات الحية
                // ملاحظة: تم إزالة orderBy لتجنب الحاجة إلى فهارس مركبة في Firestore
                onSnapshot(studentsRef, (querySnapshot) => {
                    if (querySnapshot.empty) {
                        container.innerHTML = '<p class="text-gray-500 text-center">لم يتم تسجيل أي طلاب حتى الآن.</p>';
                        return;
                    }

                    // جلب جميع التقييمات لحساب المتوسط
                    getDocs(ratingsRef).then(ratingsSnapshot => {
                        const allRatings = ratingsSnapshot.docs.map(doc => doc.data());

                        // جلب الإعدادات (نحتاجها لاسم التقرير)
                        loadSettings().then(() => {
                            container.innerHTML = ''; // مسح الحاوية
                            
                            // فرز الطلاب محلياً حسب تاريخ الإنشاء (الأحدث أولاً)
                            const students = querySnapshot.docs
                                .map(doc => ({ id: doc.id, ...doc.data() }))
                                .sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());

                            students.forEach(student => {
                                // حساب متوسط تقييم الطالب
                                const studentRatings = allRatings.filter(r => r.studentId === student.id);
                                let avgScore = 0;
                                if (studentRatings.length > 0) {
                                    const totalScore = studentRatings.reduce((sum, r) => {
                                        return sum + r.scores.preparation + r.scores.diversity + r.scores.clarity + r.scores.delivery;
                                    }, 0);
                                    const totalCriteria = studentRatings.length * 4;
                                    avgScore = (totalScore / totalCriteria) * 5; // المتوسط من 5
                                }

                                const studentCard = document.createElement('div');
                                studentCard.className = "p-4 bg-gray-50 rounded-lg shadow-md border border-gray-200 flex flex-col md:flex-row justify-between items-center gap-4 transition duration-300 hover:shadow-lg hover:bg-white";
                                
                                studentCard.innerHTML = `
                                    <div class="flex-grow">
                                        <h4 class="text-xl font-semibold text-blue-700">${student.name}</h4>
                                        <p class="text-sm text-gray-600">
                                            ${student.grade} / ${student.section} (${student.department}) | مجموعة: ${student.group}
                                        </p>
                                        <p class="text-sm text-gray-500">تاريخ الإذاعة: ${student.broadcastDate}</p>
                                    </div>
                                    <div class="flex-shrink-0 flex items-center gap-3">
                                        <span class="text-lg font-bold ${avgScore > 0 ? 'text-green-600' : 'text-gray-400'}">
                                            ${avgScore > 0 ? avgScore.toFixed(1) + ' / 5.0' : 'لم يتم التقييم'}
                                        </span>
                                        <button classdata-student-id="${student.id}" class="export-student-pdf py-2 px-4 rounded-lg font-semibold shadow-md transition duration-300 ease-in-out bg-gradient-to-r from-green-500 to-teal-600 text-white hover:from-green-600 hover:to-teal-700">
                                            تصدير (PDF)
                                        </button>
                                        <button data-student-id="${student.id}" class="rate-student py-2 px-6 rounded-lg font-semibold shadow-md transition duration-300 ease-in-out bg-blue-600 text-white hover:bg-blue-700">
                                            تقييم
                                        </button>
                                    </div>
                                `;

                                // تخزين بيانات الطالب في الزر لتجنب إعادة الجلب
                                const rateButton = studentCard.querySelector('.rate-student');
                                rateButton.studentData = student; 
                                
                                const exportButton = studentCard.querySelector('.export-student-pdf');
                                exportButton.studentData = student;

                                container.appendChild(studentCard);
                            });

                            // إضافة مستمعي الأحداث بعد إنشاء الأزرار
                            container.querySelectorAll('.rate-student').forEach(button => {
                                button.addEventListener('click', () => showRatingForm(button.studentData));
                            });
                            container.querySelectorAll('.export-student-pdf').forEach(button => {
                                button.addEventListener('click', (e) => {
                                    e.stopPropagation(); // منع تفعيل أي حدث آخر
                                    generateSingleStudentReport(button.studentData);
                                });
                            });
                        });
                    });
                });
            } catch (error) {
                console.error("Error loading students: ", error);
                container.innerHTML = `<p class="text-red-500 text-center">حدث خطأ أثناء تحميل الطلاب: ${error.message}</p>`;
            }
        }

        // --- وحدة التقييم (نموذج التقييم) ---
        
        // إظهار نموذج التقييم وتعيين بيانات الطالب
        function showRatingForm(student) {
            currentStudentId = student.id;
            document.getElementById('ratingStudentName').textContent = student.name;
            showPage('ratingPage');
            
            // إعادة تعيين النموذج
            document.getElementById('ratingForm').reset();
            document.getElementById('criteriaSection').classList.add('hidden');
            document.getElementById('ratingActions').classList.add('hidden');
            document.getElementById('evaluationHistory').classList.add('hidden');
            document.getElementById('loadingRatingMessage').classList.add('hidden');
            document.getElementById('evaluatorName').value = ""; // مسح اختيار المقيّم
            currentRatingDocId = null; // إعادة تعيين معرف التقييم
            
            // تحميل سجل التقييمات السابقة لهذا الطالب
            loadEvaluationHistory(student.id);
        }

        // اختيار المقيّم (يؤدي لتحميل تقييمه السابق إن وجد)
        document.getElementById('evaluatorName').addEventListener('change', async (e) => {
            const evaluatorName = e.target.value;
            if (!evaluatorName || !currentStudentId) {
                document.getElementById('criteriaSection').classList.add('hidden');
                document.getElementById('ratingActions').classList.add('hidden');
                return;
            }

            // إظهار النموذج
            document.getElementById('criteriaSection').classList.remove('hidden');
            document.getElementById('ratingActions').classList.remove('hidden');
            document.getElementById('loadingRatingMessage').classList.remove('hidden');
            document.getElementById('loadingRatingMessage').textContent = "جاري البحث عن تقييم سابق...";
            
            // إعادة تعيين أزرار الدرجات
            resetScoreButtons();
            currentRatingDocId = null;

            // البحث عن تقييم سابق من هذا المقيّم لنفس الطالب
            try {
                const q = query(ratingsRef, 
                    where("studentId", "==", currentStudentId),
                    where("evaluatorName", "==", evaluatorName)
                );
                
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    // وُجد تقييم سابق
                    const doc = querySnapshot.docs[0]; // افتراض وجود تقييم واحد فقط لكل مقيّم
                    currentRatingDocId = doc.id;
                    const data = doc.data();
                    
                    // ملء النموذج بالبيانات القديمة
                    setScoreButton('preparation', data.scores.preparation);
                    setScoreButton('diversity', data.scores.diversity);
                    setScoreButton('clarity', data.scores.clarity);
                    setScoreButton('delivery', data.scores.delivery);
                    
                    document.getElementById('loadingRatingMessage').textContent = "تم تحميل التقييم السابق بنجاح. يمكنك التعديل الآن.";
                } else {
                    // لا يوجد تقييم سابق
                    document.getElementById('loadingRatingMessage').textContent = "هذا تقييم جديد. الرجاء إدخال الدرجات.";
                }
            } catch (error) {
                console.error("Error loading previous rating: ", error);
                showMessage("خطأ", `حدث خطأ أثناء تحميل التقييم السابق: ${error.message}`, "error");
                document.getElementById('loadingRatingMessage').classList.add('hidden');
            }
        });

        // إدارة أزرار اختيار الدرجات
        document.querySelectorAll('.score-buttons').forEach(container => {
            container.addEventListener('click', (e) => {
                if (e.target.classList.contains('score-btn')) {
                    const button = e.target;
                    const criteria = container.dataset.criteria; // 'preparation', 'diversity', etc.
                    const score = button.dataset.score;
                    setScoreButton(criteria, score);
                }
            });
        });

        function setScoreButton(criteria, score) {
            const scoreValue = parseInt(score);
            // البحث عن الحاوية والأزرار
            const container = document.querySelector(`.score-buttons[data-criteria="${criteria}"]`);
            if (!container) return;
            
            // إزالة التحديد من جميع الأزرار في هذه المجموعة
            container.querySelectorAll('.score-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'shadow-inner');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            });
            
            // تحديد الزر المختار
            const selectedBtn = container.querySelector(`button[data-score="${scoreValue}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('bg-blue-600', 'text-white', 'shadow-inner');
                selectedBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            }
            
            // تخزين القيمة في الحقل المخفي
            document.getElementById(`${criteria}Score`).value = scoreValue;
        }

        function resetScoreButtons() {
            document.querySelectorAll('.score-buttons').forEach(container => {
                container.querySelectorAll('.score-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white', 'shadow-inner');
                    btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                });
            });
            // مسح الحقول المخفية
            document.querySelectorAll('input[type="hidden"][data-criteria-name]').forEach(input => {
                input.value = "";
            });
        }

        // حفظ التقييم (جديد أو تحديث)
        document.getElementById('ratingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId || !ratingsRef || !currentStudentId) return;

            const evaluatorName = document.getElementById('evaluatorName').value;
            const scores = {
                preparation: parseInt(document.getElementById('preparationScore').value),
                diversity: parseInt(document.getElementById('diversityScore').value),
                clarity: parseInt(document.getElementById('clarityScore').value),
                delivery: parseInt(document.getElementById('deliveryScore').value)
            };

            // التحقق من اكتمال النموذج
            if (!evaluatorName || Object.values(scores).some(isNaN)) {
                showMessage("خطأ في الإدخال", "الرجاء اختيار اسم المقيّم وتحديد درجة لجميع المعايير.", "error");
                return;
            }

            const ratingData = {
                studentId: currentStudentId,
                evaluatorName: evaluatorName,
                scores: scores,
                ratedAt: Timestamp.now(),
                ratedDate: new Date().toLocaleDateString('ar-EG') // تاريخ مقروء
            };

            try {
                if (currentRatingDocId) {
                    // تحديث تقييم موجود
                    const docRef = doc(ratingsRef, currentRatingDocId);
                    await updateDoc(docRef, ratingData);
                    showMessage("نجاح", "تم تحديث التقييم بنجاح!", "success");
                } else {
                    // إضافة تقييم جديد
                    await addDoc(ratingsRef, ratingData);
                    showMessage("نجاح", "تم حفظ التقييم الجديد بنجاح!", "success");
                }
                // إعادة تحميل سجل التقييمات
                loadEvaluationHistory(currentStudentId);
            } catch (error) {
                console.error("Error saving rating: ", error);
                showMessage("خطأ", `حدث خطأ أثناء حفظ التقييم: ${error.message}`, "error");
            }
        });

        // تحميل سجل التقييمات السابق للطالب
        async function loadEvaluationHistory(studentId) {
            const historyContainer = document.getElementById('evaluationHistory');
            const tableContainer = document.getElementById('historyTableContainer');
            
            try {
                const q = query(ratingsRef, where("studentId", "==", studentId));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    tableContainer.innerHTML = '<p class="text-gray-500 text-center">لا توجد تقييمات سابقة لهذا الطالب.</p>';
                    historyContainer.classList.remove('hidden');
                    return;
                }

                let ratings = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // فرز التقييمات محلياً (الأحدث أولاً)
                ratings.sort((a, b) => b.ratedAt.toMillis() - a.ratedAt.toMillis());

                let tableHTML = `
                    <table class="w-full min-w-max text-right border-collapse">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="p-3 border border-gray-300">اسم المقيّم</th>
                                <th class="p-3 border border-gray-300">متوسط الدرجات (من 5)</th>
                                <th class="p-3 border border-gray-300">تاريخ التقييم</th>
                                <th class="p-3 border border-gray-300">التفاصيل</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                ratings.forEach((rating, index) => {
                    const s = rating.scores;
                    const avg = ((s.preparation + s.diversity + s.clarity + s.delivery) / 4);
                    const avgOutOf5 = avg.toFixed(1);

                    tableHTML += `
                        <tr class="bg-white hover:bg-gray-50">
                            <td class="p-3 border border-gray-300">${rating.evaluatorName}</td>
                            <td class="p-3 border border-gray-300 font-bold ${avg >= 3 ? 'text-green-600' : 'text-red-600'}">${avgOutOf5}</td>
                            <td class="p-3 border border-gray-300">${rating.ratedDate || rating.ratedAt.toDate().toLocaleDateString('ar-EG')}</td>
                            <td class="p-3 border border-gray-300">
                                <button type="button" onclick="toggleDetails('details_${index}')" class="text-blue-600 hover:underline text-sm">التفاصيل</button>
                            </td>
                        </tr>
                        <tr id="details_${index}" class="hidden bg-gray-100">
                            <td colspan="4" class="p-4 border border-gray-300">
                                <ul class="list-disc list-inside space-y-1 text-sm">
                                    <li>الإعداد الجيد: <span class="font-semibold">${scoreToText(s.preparation)} (${s.preparation})</span></li>
                                    <li>التنوع: <span class="font-semibold">${scoreToText(s.diversity)} (${s.diversity})</span></li>
                                    <li>وضوح الرسالة: <span class="font-semibold">${scoreToText(s.clarity)} (${s.clarity})</span></li>
                                    <li>جودة الإلقاء: <span class="font-semibold">${scoreToText(s.delivery)} (${s.delivery})</span></li>
                                </ul>
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `</tbody></table>`;
                tableContainer.innerHTML = tableHTML;
                historyContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Error loading history: ", error);
                tableContainer.innerHTML = `<p class="text-red-500 text-center">حدث خطأ أثناء تحميل السجل: ${error.message}</p>`;
                historyContainer.classList.remove('hidden');
            }
        }

        window.toggleDetails = (id) => {
            document.getElementById(id).classList.toggle('hidden');
        }

        function scoreToText(score) {
            const s = parseInt(score);
            if (s === 5) return 'ممتاز';
            if (s === 4) return 'جيد جداً';
            if (s === 3) return 'جيد';
            if (s === 2) return 'مقبول';
            if (s === 1) return 'ضعيف';
            return 'N/A';
        }

        // --- وحدة الإعدادات ---

        // تحميل الإعدادات من Firestore
        async function loadSettings() {
            if (!settingsRef) return;
            try {
                const docSnap = await getDoc(settingsRef);
                if (docSnap.exists()) {
                    appSettings = { ...appSettings, ...docSnap.data() }; // دمج الإعدادات
                } else {
                    // إذا لم توجد إعدادات، يتم حفظ الإعدادات الافتراضية
                    await setDoc(settingsRef, appSettings);
                }
            } catch (error) {
                console.error("Error loading settings: ", error);
            }
        }

        // ملء نموذج الإعدادات
        function fillSettingsForm() {
            document.getElementById('reportTitle').value = appSettings.reportTitle;
            document.getElementById('reportFooter').value = appSettings.reportFooter;
            const preview = document.getElementById('imagePreview');
            const removeBtn = document.getElementById('removeImageBtn');
            if (appSettings.headerImageBase64) {
                preview.src = appSettings.headerImageBase64;
                preview.classList.remove('hidden');
                removeBtn.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
                removeBtn.classList.add('hidden');
                document.getElementById('reportHeaderImage').value = ''; // مسح حقل الملف
            }
        }

        // حفظ الإعدادات
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            appSettings.reportTitle = document.getElementById('reportTitle').value;
            appSettings.reportFooter = document.getElementById('reportFooter').value;
            // الصورة تمت معالجتها بواسطة 'change' event listener

            try {
                await setDoc(settingsRef, appSettings);
                showMessage("نجاح", "تم حفظ الإعدادات بنجاح.", "success");
            } catch (error) {
                console.error("Error saving settings: ", error);
                showMessage("خطأ", `حدث خطأ أثناء حفظ الإعدادات: ${error.message}`, "error");
            }
        });

        // معالجة رفع الصورة وتحويلها إلى Base64
        document.getElementById('reportHeaderImage').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64String = event.target.result;
                    appSettings.headerImageBase64 = base64String;
                    document.getElementById('imagePreview').src = base64String;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    document.getElementById('removeImageBtn').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // إزالة الصورة
        document.getElementById('removeImageBtn').addEventListener('click', () => {
            appSettings.headerImageBase64 = null;
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('removeImageBtn').classList.add('hidden');
            document.getElementById('reportHeaderImage').value = '';
        });

        // --- وحدة تصدير PDF ---

        // حساب الوضع (الدرجة الأكثر تكراراً) أو المتوسط
        function calculateModeOrAverage(scores) {
            if (!scores || scores.length === 0) return 0;

            const counts = {};
            let total = 0;
            
            scores.forEach(s => {
                counts[s] = (counts[s] || 0) + 1;
                total += s;
            });

            let maxCount = 0;
            let mode = [];
            
            for (const score in counts) {
                if (counts[score] > maxCount) {
                    maxCount = counts[score];
                    mode = [parseInt(score)];
                } else if (counts[score] === maxCount) {
                    mode.push(parseInt(score));
                }
            }

            // إذا كان هناك وضع واحد (الأكثر تكراراً)
            if (mode.length === 1) {
                return mode[0];
            } else {
                // إذا كان هناك تعادل (أو جميع القيم مختلفة)
                // نستخدم المتوسط الحسابي ونقربه
                return Math.round(total / scores.length);
            }
        }

        // إنشاء تقرير الطالب الواحد (PDF)
        async function generateSingleStudentReport(studentData) {
            if (!ratingsRef) return;
            
            const pdfContent = document.getElementById('pdf-content');
            pdfContent.innerHTML = `<p class="text-center">جاري تحضير التقرير...</p>`;
            document.getElementById('pdfPreviewModal').classList.remove('hidden');

            try {
                // جلب جميع تقييمات هذا الطالب
                const q = query(ratingsRef, where("studentId", "==", studentData.id));
                const querySnapshot = await getDocs(q);
                const ratings = querySnapshot.docs.map(d => d.data());

                if (ratings.length === 0) {
                    pdfContent.innerHTML = `<p class="text-center text-red-500">لا توجد تقييمات لهذا الطالب. لا يمكن إنشاء التقرير.</p>`;
                    document.getElementById('pdfConfirmButton').disabled = true;
                    return;
                }
                
                document.getElementById('pdfConfirmButton').disabled = false;

                // تجميع الدرجات لكل معيار
                const criteriaScores = {
                    preparation: ratings.map(r => r.scores.preparation),
                    diversity: ratings.map(r => r.scores.diversity),
                    clarity: ratings.map(r => r.scores.clarity),
                    delivery: ratings.map(r => r.scores.delivery)
                };

                // حساب النتيجة النهائية (الوضع أو المتوسط) لكل معيار
                const finalScores = {
                    preparation: calculateModeOrAverage(criteriaScores.preparation),
                    diversity: calculateModeOrAverage(criteriaScores.diversity),
                    clarity: calculateModeOrAverage(criteriaScores.clarity),
                    delivery: calculateModeOrAverage(criteriaScores.delivery)
                };

                // جلب أسماء المقيّمين (بدون تكرار)
                const evaluators = [...new Set(ratings.map(r => r.evaluatorName))].join('، ');

                // بناء محتوى التقرير (HTML)
                let reportHTML = `
                    <div class="report-container p-4 border border-gray-300" style="font-family: 'Tajawal', sans-serif;">
                        ${appSettings.headerImageBase64 ? `<img src="${appSettings.headerImageBase64}" alt="Header" class="max-h-24 mx-auto mb-6"/>` : ''}
                        
                        <h2 class="text-3xl font-bold text-center mb-4">${appSettings.reportTitle || 'تقرير تقييم الطالب'}</h2>
                        <p class="text-center text-gray-500 mb-8">تاريخ الإصدار: ${new Date().toLocaleDateString('ar-EG')}</p>
                        
                        <!-- معلومات الطالب -->
                        <div class="grid grid-cols-2 gap-x-8 gap-y-4 mb-8 p-4 bg-gray-50 rounded-lg border">
                            <div><strong class="text-gray-700">اسم الطالب:</strong> ${studentData.name}</div>
                            <div><strong class="text-gray-700">القسم:</strong> ${studentData.department}</div>
                            <div><strong class="text-gray-700">الصف:</strong> ${studentData.grade} / ${studentData.section}</div>
                            <div><strong class="text-gray-700">مجموعة المربي:</strong> ${studentData.group}</div>
                        </div>

                        <h3 class="text-xl font-semibold mb-4 text-center">النتيجة المجمعة للتقييم</h3>
                        
                        <!-- جدول التقييم بعلامات الصح -->
                        <table class="w-full text-center border-collapse border border-gray-400 mb-8">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="p-3 border border-gray-400 text-right">عناصر التقييم</th>
                                    <th class="p-3 border border-gray-400">ممتاز (5)</th>
                                    <th class="p-3 border border-gray-400">جيد جداً (4)</th>
                                    <th class="p-3 border border-gray-400">جيد (3)</th>
                                    <th class="p-3 border border-gray-400">مقبول (2)</th>
                                    <th class="p-3 border border-gray-400">ضعيف (1)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${buildCheckmarkRow('الإعداد الجيد', finalScores.preparation)}
                                ${buildCheckmarkRow('التنوع', finalScores.diversity)}
                                ${buildCheckmarkRow('وضوح الرسالة الموجهة', finalScores.clarity)}
                                ${buildCheckmarkRow('جودة الإلقاء', finalScores.delivery)}
                            </tbody>
                        </table>
                        
                        <!-- لجنة التقييم -->
                        <div class="mt-12 text-center">
                            <h4 class="text-lg font-semibold">${appSettings.reportFooter || 'لجنة التقييم'}</h4>
                            <p class="text-gray-700 mt-2">${evaluators}</p>
                        </div>
                    </div>
                `;

                pdfContent.innerHTML = reportHTML;

                // إعداد زر تأكيد التصدير
                const confirmBtn = document.getElementById('pdfConfirmButton');
                // إزالة المستمع القديم وإضافة واحد جديد
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                newConfirmBtn.addEventListener('click', () => {
                    exportToPDF(pdfContent, `تقرير_${studentData.name.replace(/ /g, '_')}`);
                });

            } catch (error) {
                console.error("Error generating report: ", error);
                pdfContent.innerHTML = `<p class="text-center text-red-500">حدث خطأ أثناء إنشاء التقرير: ${error.message}</p>`;
                document.getElementById('pdfConfirmButton').disabled = true;
            }
        }

        // دالة مساعدة لبناء صف في جدول علامات الصح
        function buildCheckmarkRow(criteriaName, score) {
            const levels = [5, 4, 3, 2, 1];
            let cells = '';
            levels.forEach(level => {
                const checkmark = (level === score) ? '<span class="text-green-600 font-bold text-xl">✓</span>' : '';
                cells += `<td class="p-3 border border-gray-400">${checkmark}</td>`;
            });
            return `
                <tr class="bg-white">
                    <td class="p-3 border border-gray-400 text-right font-medium">${criteriaName}</td>
                    ${cells}
                </tr>
            `;
        }

        // إنشاء تقرير جميع الطلاب (PDF)
        document.getElementById('exportAllStudents').addEventListener('click', async () => {
            if (!studentsRef || !ratingsRef) return;

            const pdfContent = document.getElementById('pdf-content');
            pdfContent.innerHTML = `<p class="text-center">جاري تحضير التقرير المجمع...</p>`;
            document.getElementById('pdfPreviewModal').classList.remove('hidden');

            try {
                // جلب جميع الطلاب وجميع التقييمات
                const [studentsSnap, ratingsSnap] = await Promise.all([
                    getDocs(studentsRef),
                    getDocs(ratingsRef)
                ]);

                if (studentsSnap.empty || ratingsSnap.empty) {
                    pdfContent.innerHTML = `<p class="text-center text-red-500">لا توجد بيانات طلاب أو تقييمات لإنشاء التقرير.</p>`;
                    document.getElementById('pdfConfirmButton').disabled = true;
                    return;
                }
                
                document.getElementById('pdfConfirmButton').disabled = false;

                const students = studentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const allRatings = ratingsSnap.docs.map(doc => doc.data());

                let evaluatorsSet = new Set();
                let tableRows = '';
                let evaluatedStudentsCount = 0;

                students.forEach(student => {
                    const studentRatings = allRatings.filter(r => r.studentId === student.id);
                    if (studentRatings.length === 0) return; // تخطي الطلاب غير المقيمين

                    evaluatedStudentsCount++;
                    studentRatings.forEach(r => evaluatorsSet.add(r.evaluatorName));

                    // حساب متوسط درجات الطالب
                    const totalScore = studentRatings.reduce((sum, r) => {
                        return sum + r.scores.preparation + r.scores.diversity + r.scores.clarity + r.scores.delivery;
                    }, 0);
                    const totalCriteria = studentRatings.length * 4;
                    const avgScoreOutOf5 = ((totalScore / totalCriteria) * 5).toFixed(1);

                    tableRows += `
                        <tr class="bg-white hover:bg-gray-50">
                            <td class="p-3 border border-gray-400 text-right">${student.name}</td>
                            <td class="p-3 border border-gray-400 text-center">${student.grade}</td>
                            <td class="p-3 border border-gray-400 text-center">${student.group}</td>
                            <td class="p-3 border border-gray-400 text-center font-bold text-blue-700">${avgScoreOutOf5} / 5.0</td>
                            <td class="p-3 border border-gray-400 text-center">${studentRatings.length}</td>
                        </tr>
                    `;
                });

                if (evaluatedStudentsCount === 0) {
                    pdfContent.innerHTML = `<p class="text-center text-red-500">لم يتم تقييم أي طالب حتى الآن.</p>`;
                    document.getElementById('pdfConfirmButton').disabled = true;
                    return;
                }

                const evaluators = [...evaluatorsSet].join('، ');

                let reportHTML = `
                    <div class="report-container p-4" style="font-family: 'Tajawal', sans-serif;">
                        ${appSettings.headerImageBase64 ? `<img src="${appSettings.headerImageBase64}" alt="Header" class="max-h-24 mx-auto mb-6"/>` : ''}
                        
                        <h2 class="text-3xl font-bold text-center mb-4">${appSettings.reportTitle || 'تقرير مجمع لنتائج الطلاب'}</h2>
                        <p class="text-center text-gray-500 mb-8">تاريخ الإصدار: ${new Date().toLocaleDateString('ar-EG')}</p>
                        <p class="text-center text-gray-700 mb-8">إجمالي الطلاب المقيمين: ${evaluatedStudentsCount}</p>

                        <table class="w-full text-right border-collapse border border-gray-400 mb-8">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="p-3 border border-gray-400">اسم الطالب</th>
                                    <th class="p-3 border border-gray-400 text-center">الصف</th>
                                    <th class="p-3 border border-gray-400 text-center">المجموعة</th>
                                    <th class="p-3 border border-gray-400 text-center">النتيجة النهائية (من 5)</th>
                                    <th class="p-3 border border-gray-400 text-center">عدد التقييمات</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                        
                        <div class="mt-12 text-center">
                            <h4 class="text-lg font-semibold">${appSettings.reportFooter || 'لجنة التقييم'}</h4>
                            <p class="text-gray-700 mt-2">${evaluators}</p>
                        </div>
                    </div>
                `;

                pdfContent.innerHTML = reportHTML;
                
                // إعداد زر تأكيد التصدير
                const confirmBtn = document.getElementById('pdfConfirmButton');
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                newConfirmBtn.addEventListener('click', () => {
                    exportToPDF(pdfContent, 'تقرير_النتائج_المجمع');
                });

            } catch (error) {
                console.error("Error generating all students report: ", error);
                pdfContent.innerHTML = `<p class="text-center text-red-500">حدث خطأ أثناء إنشاء التقرير: ${error.message}</p>`;
                document.getElementById('pdfConfirmButton').disabled = true;
            }
        });


        // دالة التصدير إلى PDF الفعلية
        async function exportToPDF(element, filename) {
            // إظهار رسالة جاري التحميل
            const confirmBtn = document.getElementById('pdfConfirmButton');
            const originalText = confirmBtn.textContent;
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'جاري الإنشاء...';

            try {
                // استخدام html2canvas لتحويل العنصر إلى صورة
                const canvas = await html2canvas(element, {
                    scale: 2, // زيادة الدقة
                    useCORS: true // للسماح بتحميل الصور الخارجية (إذا وجدت)
                });
                
                const imgData = canvas.toDataURL('image/png');
                
                // استخدام jsPDF لإنشاء ملف PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'p', // 'p' for portrait
                    unit: 'mm',
                    format: 'a4'
                });

                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                let heightLeft = pdfHeight;
                let position = 0;
                const pageHeight = pdf.internal.pageSize.getHeight();

                // إضافة الصفحة الأولى
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                heightLeft -= pageHeight;

                // إضافة صفحات إضافية إذا كان المحتوى طويلاً
                while (heightLeft > 0) {
                    position = heightLeft - pdfHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                    heightLeft -= pageHeight;
                }
                
                // حفظ الملف
                pdf.save(`${filename}.pdf`);
                
                // إخفاء نافذة المعاينة
                closeModal('pdfPreviewModal');

            } catch (error) {
                console.error("Error exporting PDF: ", error);
                showMessage("خطأ", `فشل تصدير PDF: ${error.message}`, "error");
            } finally {
                // إعادة الزر لحالته الأصلية
                confirmBtn.disabled = false;
                confirmBtn.textContent = originalText;
            }
        }

        // --- وحدة تصدير التطبيق ---
        document.getElementById('exportAppButton').addEventListener('click', () => {
            try {
                // الحصول على كود HTML الحالي للصفحة بالكامل
                const htmlContent = document.documentElement.outerHTML;
                
                // إنشاء كائن Blob (Binary Large Object)
                const blob = new Blob([htmlContent], { type: 'text/html' });
                
                // إنشاء رابط تحميل مؤقت
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'student_evaluation_app_export.html'; // اسم الملف
                
                // إخفاء الرابط وإضافته للصفحة
                a.style.display = 'none';
                document.body.appendChild(a);
                
                // الضغط على الرابط برمجياً لبدء التحميل
                a.click();
                
                // إزالة الرابط من الصفحة
                document.body.removeChild(a);
                // تحرير الـ URL
                URL.revokeObjectURL(a.href);

                showMessage("نجاح", "تم بدء تحميل ملف التطبيق (student_evaluation_app_export.html) بنجاح.", "success");
            } catch (error) {
                console.error("Error exporting app HTML: ", error);
                showMessage("خطأ", `فشل تصدير التطبيق: ${error.message}`, "error");
            }
        });

        // --- بدء تشغيل التطبيق ---
        initializeMain();

        // إضافة أنماط CSS الديناميكية للأزرار (للتفاعلية)
        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText = `
            .score-btn {
                padding: 0.75rem 1rem;
                border-radius: 0.5rem;
                font-weight: 600;
                transition: all 0.2s ease-in-out;
                background-color: #e5e7eb; /* bg-gray-200 */
                color: #374151; /* text-gray-700 */
                border: 1px solid #d1d5db; /* border-gray-300 */
            }
            .score-btn:hover {
                background-color: #d1d5db; /* hover:bg-gray-300 */
            }
            .score-btn.selected {
                background-color: #3b82f6; /* bg-blue-600 */
                color: white;
                box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
                border-color: #2563eb;
            }
        `;
        document.head.appendChild(styleSheet);


    </script>
    

</body></html>